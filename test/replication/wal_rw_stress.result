test_run = require('test_run').new()
---
...
--
-- gh-3893: Replication failure: relay may report that an xlog
-- is corrupted if it it currently being written to.
--
s = box.schema.space.create('test')
---
...
_ = s:create_index('primary')
---
...
-- Deploy a replica.
box.schema.user.grant('guest', 'replication')
---
...
test_run:cmd("create server wal_rw_stress with rpl_master=default, script='replication/replica.lua'")
---
- true
...
test_run:cmd("start server wal_rw_stress")
---
- true
...
-- Setup replica => master channel.
box.cfg{replication = test_run:cmd("eval wal_rw_stress 'return box.cfg.listen'")}
---
...
-- Disable master => wal_rw_stress channel.
test_run:cmd("switch wal_rw_stress")
---
- true
...
replication = box.cfg.replication
---
...
box.cfg{replication = {}}
---
...
test_run:cmd("switch default")
---
- true
...
-- Write some xlogs on the master.
test_run:cmd("setopt delimiter ';'")
---
- true
...
for i = 1, 100 do
    box.begin()
    for j = 1, 100 do
        s:replace{1, require('digest').urandom(1000)}
    end
    box.commit()
end;
---
...
test_run:cmd("setopt delimiter ''");
---
- true
...
-- Enable master => wal_rw_stress channel and wait for the replica to catch up.
-- The relay handling wal_rw_stress => master channel on the replica will read
-- an xlog while the applier is writing to it. Although applier and relay
-- are running in different threads, there shouldn't be any rw errors.
test_run:cmd("switch wal_rw_stress")
---
- true
...
box.cfg{replication = replication}
---
...
test_run:wait_cond(function() return box.info.replication[1].downstream.status ~= 'stopped' end) or box.info
---
- true
...
test_run:cmd("switch default")
---
- true
...
-- Cleanup.
box.cfg{replication = {}}
---
...
test_run:cmd("stop server wal_rw_stress")
---
- true
...
test_run:cmd("cleanup server wal_rw_stress")
---
- true
...
test_run:cmd("delete server wal_rw_stress")
---
- true
...
test_run:cleanup_cluster()
---
...
box.schema.user.revoke('guest', 'replication')
---
...
s:drop()
---
...
