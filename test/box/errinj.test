# encoding: utf-8
#
import sys
# clear statistics:
server.stop()
server.deploy()

admin("show injections")
admin("set injection some-injection on")
sql("select * from t0 where k0 = 222444")
admin("set injection ERRINJ_TESTING on")
sql("select * from t0 where k0 = 222444")
admin("set injection ERRINJ_TESTING off")

# Check how well we handle a failed log write.
admin("set injection ERRINJ_WAL_IO on")
sql("insert into t0 values (1)")
sql("select * from t0 where k0=1")
admin("set injection ERRINJ_WAL_IO off")
sql("insert into t0 values (1)")
admin("set injection ERRINJ_WAL_IO on")
sql("update t0 set k0=2 where k0=1")
sql("select * from t0 where k0=1")
sql("select * from t0 where k0=2")
admin("set injection ERRINJ_WAL_IO off")
admin("lua box.space[0]:truncate()")

# Check a failed log rotation.
admin("set injection ERRINJ_WAL_ROTATE on")
sql("insert into t0 values (1)")
sql("select * from t0 where k0=1")
admin("set injection ERRINJ_WAL_ROTATE off")
sql("insert into t0 values (1)")
admin("set injection ERRINJ_WAL_ROTATE on")
sql("update t0 set k0=2 where k0=1")
sql("select * from t0 where k0=1")
sql("select * from t0 where k0=2")
admin("set injection ERRINJ_WAL_ROTATE off")
sql("update t0 set k0=2 where k0=1")
sql("select * from t0 where k0=1")
sql("select * from t0 where k0=2")
admin("set injection ERRINJ_WAL_ROTATE on")
admin("lua box.space[0]:truncate()")
admin("set injection ERRINJ_WAL_ROTATE off")
admin("lua box.space[0]:truncate()")
# vim: syntax=python
