s = box.schema.space.create('tweedledum')
---
...
index = s:create_index('pk')
---
...
-- test delete field
s:insert{1000001, 1000002, 1000003, 1000004, 1000005}
---
- [1000001, 1000002, 1000003, 1000004, 1000005]
...
s:update({1000001}, {{'#', 1, 1}})
---
- error: Attempt to modify a tuple field which is part of index 'pk' in space 'tweedledum'
...
s:update({1000001}, {{'#', 1, "only one record please"}})
---
- error: 'Argument type in operation ''#'' on field 1 does not match field type: expected
    a positive integer'
...
s:truncate()
---
...
-- test arithmetic
s:insert{1, 0}
---
- [1, 0]
...
s:update(1, {{'+', 2, 10}})
---
- [1, 10]
...
s:update(1, {{'+', 2, 15}})
---
- [1, 25]
...
s:update(1, {{'-', 2, 5}})
---
- [1, 20]
...
s:update(1, {{'-', 2, 20}})
---
- [1, 0]
...
s:update(1, {{'|', 2, 0x9}})
---
- [1, 9]
...
s:update(1, {{'|', 2, 0x6}})
---
- [1, 15]
...
s:update(1, {{'&', 2, 0xabcde}})
---
- [1, 14]
...
s:update(1, {{'&', 2, 0x2}})
---
- [1, 2]
...
s:update(1, {{'^', 2, 0xa2}})
---
- [1, 160]
...
s:update(1, {{'^', 2, 0xa2}})
---
- [1, 2]
...
s:truncate()
---
...
-- test delete multiple fields
s:insert{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15}
---
- [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
...
s:update({0}, {{'#', 42, 1}})
---
- [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
...
s:update({0}, {{'#', 4, 'abirvalg'}})
---
- error: 'Argument type in operation ''#'' on field 4 does not match field type: expected
    a positive integer'
...
s:update({0}, {{'#', 2, 1}, {'#', 4, 2}, {'#', 6, 1}})
---
- [0, 2, 3, 6, 7, 9, 10, 11, 12, 13, 14, 15]
...
s:update({0}, {{'#', 4, 3}})
---
- [0, 2, 3, 10, 11, 12, 13, 14, 15]
...
s:update({0}, {{'#', 5, 123456}})
---
- [0, 2, 3, 10]
...
s:update({0}, {{'#', 3, 4294967295}})
---
- [0, 2]
...
s:update({0}, {{'#', 2, 0}})
---
- error: 'Field 2 UPDATE error: cannot delete 0 fields'
...
s:truncate()
---
...
-- test insert field
s:insert{1, 3, 6, 9}
---
- [1, 3, 6, 9]
...
s:update({1}, {{'!', 2, 2}})
---
- [1, 2, 3, 6, 9]
...
s:update({1}, {{'!', 4, 4}, {'!', 4, 5}, {'!', 5, 7}, {'!', 5, 8}})
---
- [1, 2, 3, 5, 8, 7, 4, 6, 9]
...
s:update({1}, {{'!', 10, 10}, {'!', 10, 11}, {'!', 10, 12}})
---
- [1, 2, 3, 5, 8, 7, 4, 6, 9, 12, 11, 10]
...
s:truncate()
---
...
s:insert{1, 'tuple'}
---
- [1, 'tuple']
...
s:update({1}, {{'#', 2, 1}, {'!', 2, 'inserted tuple'}, {'=', 3, 'set tuple'}})
---
- [1, 'inserted tuple', 'set tuple']
...
s:truncate()
---
...
s:insert{1, 'tuple'}
---
- [1, 'tuple']
...
s:update({1}, {{'=', 2, 'set tuple'}, {'!', 2, 'inserted tuple'}, {'#', 3, 1}})
---
- [1, 'inserted tuple']
...
s:update({1}, {{'!', 1, 3}, {'!', 1, 2}})
---
- error: Attempt to modify a tuple field which is part of index 'pk' in space 'tweedledum'
...
s:truncate()
---
...
-- test update's assign opearations
s:replace{1, 'field string value'}
---
- [1, 'field string value']
...
s:update({1}, {{'=', 2, 'new field string value'}, {'=', 3, 42}, {'=', 4, 0xdeadbeef}})
---
- [1, 'new field string value', 42, 3735928559]
...
-- test multiple update opearations on the same field
s:update({1}, {{'+', 3, 16}, {'&', 4, 0xffff0000}, {'|', 4, 0x0000a0a0}, {'^', 4, 0xffff00aa}})
---
- error: 'Field 4 UPDATE error: double update of the same field'
...
-- test update splice operation
s:replace{1953719668, 'something to splice'}
---
- [1953719668, 'something to splice']
...
s:update(1953719668, {{':', 2, 1, 4, 'no'}})
---
- [1953719668, 'nothing to splice']
...
s:update(1953719668, {{':', 2, 1, 2, 'every'}})
---
- [1953719668, 'everything to splice']
...
-- check an incorrect offset
s:update(1953719668, {{':', 2, 100, 2, 'every'}})
---
- [1953719668, 'everything to spliceevery']
...
s:update(1953719668, {{':', 2, -100, 2, 'every'}})
---
- error: 'SPLICE error on field 2: offset is out of bound'
...
s:truncate()
---
...
s:insert{1953719668, 'hello', 'october', '20th'}:unpack()
---
- 1953719668
- hello
- october
- 20th
...
s:truncate()
---
...
s:insert{1953719668, 'hello world'}
---
- [1953719668, 'hello world']
...
s:update(1953719668, {{'=', 2, 'bye, world'}})
---
- [1953719668, 'bye, world']
...
s:delete{1953719668}
---
- [1953719668, 'bye, world']
...
s:replace({10, 'abcde'})
---
- [10, 'abcde']
...
s:update(10,  {{':', 2, 0, 0, '!'}})
---
- error: 'SPLICE error on field 2: offset is out of bound'
...
s:update(10,  {{':', 2, 1, 0, '('}})
---
- [10, '(abcde']
...
s:update(10,  {{':', 2, 2, 0, '({'}})
---
- [10, '(({abcde']
...
s:update(10,  {{':', 2, -1, 0, ')'}})
---
- [10, '(({abcde)']
...
s:update(10,  {{':', 2, -2, 0, '})'}})
---
- [10, '(({abcde}))']
...
-- test update delete operations
s:update({1}, {{'#', 4, 1}, {'#', 3, 1}})
---
...
-- test update insert operations
s:update({1}, {{'!', 2, 1}, {'!', 2, 2}, {'!', 2, 3}, {'!', 2, 4}})
---
...
-- s:update: zero field
s:insert{48}
---
- [48]
...
s:update(48, {{'=', 0, 'hello'}})
---
- error: Field 0 was not found in the tuple
...
-- s:update: push/pop fields
s:insert{1684234849}
---
- [1684234849]
...
s:update({1684234849}, {{'#', 2, 1}})
---
- [1684234849]
...
s:update({1684234849}, {{'!', -1, 'push1'}})
---
- [1684234849, 'push1']
...
s:update({1684234849}, {{'!', -1, 'push2'}})
---
- [1684234849, 'push1', 'push2']
...
s:update({1684234849}, {{'!', -1, 'push3'}})
---
- [1684234849, 'push1', 'push2', 'push3']
...
s:update({1684234849}, {{'#', 2, 1}, {'!', -1, 'swap1'}})
---
- [1684234849, 'push2', 'push3', 'swap1']
...
s:update({1684234849}, {{'#', 2, 1}, {'!', -1, 'swap2'}})
---
- [1684234849, 'push3', 'swap1', 'swap2']
...
s:update({1684234849}, {{'#', 2, 1}, {'!', -1, 'swap3'}})
---
- [1684234849, 'swap1', 'swap2', 'swap3']
...
s:update({1684234849}, {{'#', -1, 1}, {'!', -1, 'noop1'}})
---
- [1684234849, 'swap1', 'swap2', 'noop1']
...
s:update({1684234849}, {{'#', -1, 1}, {'!', -1, 'noop2'}})
---
- [1684234849, 'swap1', 'swap2', 'noop2']
...
s:update({1684234849}, {{'#', -1, 1}, {'!', -1, 'noop3'}})
---
- [1684234849, 'swap1', 'swap2', 'noop3']
...
--
-- negative indexes
--
box.tuple.new({1, 2, 3, 4, 5}):update({{'!', 0, 'Test'}})
---
- error: Field 0 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'!', -1, 'Test'}})
---
- [1, 2, 3, 4, 5, 'Test']
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'!', -3, 'Test'}})
---
- [1, 2, 3, 'Test', 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'!', -5, 'Test'}})
---
- [1, 'Test', 2, 3, 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'!', -6, 'Test'}})
---
- ['Test', 1, 2, 3, 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'!', -7, 'Test'}})
---
- error: Field -7 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'!', -100500, 'Test'}})
---
- error: Field -100500 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'=', 0, 'Test'}})
---
- error: Field 0 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'=', -1, 'Test'}})
---
- [1, 2, 3, 4, 'Test']
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'=', -3, 'Test'}})
---
- [1, 2, 'Test', 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'=', -5, 'Test'}})
---
- ['Test', 2, 3, 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'=', -6, 'Test'}})
---
- error: Field -6 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'=', -100500, 'Test'}})
---
- error: Field -100500 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'+', 0, 100}})
---
- error: Field 0 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'+', -1, 100}})
---
- [1, 2, 3, 4, 105]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'+', -3, 100}})
---
- [1, 2, 103, 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'+', -5, 100}})
---
- [101, 2, 3, 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'+', -6, 100}})
---
- error: Field -6 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'+', -100500, 100}})
---
- error: Field -100500 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'|', 0, 100}})
---
- error: Field 0 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'|', -1, 100}})
---
- [1, 2, 3, 4, 101]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'|', -3, 100}})
---
- [1, 2, 103, 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'|', -5, 100}})
---
- [101, 2, 3, 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'|', -6, 100}})
---
- error: Field -6 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'|', -100500, 100}})
---
- error: Field -100500 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'#', 0, 1}})
---
- error: Field 0 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'#', -1, 1}})
---
- [1, 2, 3, 4]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'#', -3, 1}})
---
- [1, 2, 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'#', -5, 1}})
---
- [2, 3, 4, 5]
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'#', -6, 1}})
---
- error: Field -6 was not found in the tuple
...
box.tuple.new({1, 2, 3, 4, 5}):update({{'#', -100500, 1}})
---
- error: Field -100500 was not found in the tuple
...
--
-- #416: UPDATEs from Lua can't be properly restored due to one based indexing
--
env = require('test_run')
---
...
test_run = env.new()
---
...
test_run:cmd('restart server default')
s = box.space.tweedledum
---
...
s:select{}
---
- - [10, '(({abcde}))']
  - [48]
  - [1684234849, 'swap1', 'swap2', 'noop3']
...
s:truncate()
---
...
s:drop()
---
...
-- #521: Cryptic error message in update operation
s = box.schema.space.create('tweedledum')
---
...
index = s:create_index('pk')
---
...
s:insert{1, 2, 3}
---
- [1, 2, 3]
...
s:update({1})
---
- error: Usage index:update(key, ops)
...
s:update({1}, {'=', 1, 1})
---
- error: Illegal parameters, update operation must be an array {op,..}
...
s:drop()
---
...
-- #528: Different types in arithmetical update, overflow check
ffi = require('ffi')
---
...
s = box.schema.create_space('tweedledum')
---
...
index = s:create_index('pk')
---
...
s:insert{0, -1}
---
- [0, -1]
...
-- + --
s:update({0}, {{'+', 2, "a"}}) -- err
---
- error: 'Argument type in operation ''+'' on field 2 does not match field type: expected
    a number'
...
s:update({0}, {{'+', 2, 10}}) -- neg(ative) + pos(itive) = pos(itive) 9
---
- [0, 9]
...
s:update({0}, {{'+', 2, 5}}) -- pos + pos = pos 14
---
- [0, 14]
...
s:update({0}, {{'+', 2, -4}}) -- pos + neg = pos 10
---
- [0, 10]
...
s:update({0}, {{'+', 2, -22}}) -- pos + neg = neg -12
---
- [0, -12]
...
s:update({0}, {{'+', 2, -3}}) -- neg + neg = neg -15
---
- [0, -15]
...
s:update({0}, {{'+', 2, 7}}) -- neg + pos = neg -8
---
- [0, -8]
...
-- - --
s:update({0}, {{'-', 2, "a"}}) -- err
---
- error: 'Argument type in operation ''-'' on field 2 does not match field type: expected
    a number'
...
s:update({0}, {{'-', 2, 16}}) -- neg(ative) - pos(itive) = neg(ative) -24
---
- [0, -24]
...
s:update({0}, {{'-', 2, -4}}) -- neg - neg = neg 20
---
- [0, -20]
...
s:update({0}, {{'-', 2, -32}}) -- neg - neg = pos 12
---
- [0, 12]
...
s:update({0}, {{'-', 2, 3}}) -- pos - pos = pos 9
---
- [0, 9]
...
s:update({0}, {{'-', 2, -5}}) -- pos - neg = pos 14
---
- [0, 14]
...
s:update({0}, {{'-', 2, 17}}) -- pos - pos = neg -3
---
- [0, -3]
...
-- bit --
s:replace{0, 0} -- 0
---
- [0, 0]
...
s:update({0}, {{'|', 2, 24}}) -- 24
---
- [0, 24]
...
s:update({0}, {{'|', 2, 2}}) -- 26
---
- [0, 26]
...
s:update({0}, {{'&', 2, 50}}) -- 18
---
- [0, 18]
...
s:update({0}, {{'^', 2, 6}}) -- 20
---
- [0, 20]
...
s:update({0}, {{'|', 2, -1}}) -- err
---
- error: 'Argument type in operation ''|'' on field 2 does not match field type: expected
    a positive integer'
...
s:update({0}, {{'&', 2, -1}}) -- err
---
- error: 'Argument type in operation ''&'' on field 2 does not match field type: expected
    a positive integer'
...
s:update({0}, {{'^', 2, -1}}) -- err
---
- error: 'Argument type in operation ''^'' on field 2 does not match field type: expected
    a positive integer'
...
s:replace{0, -1} -- -1
---
- [0, -1]
...
s:update({0}, {{'|', 2, 2}}) -- err
---
- error: 'Argument type in operation ''|'' on field 2 does not match field type: expected
    a positive integer'
...
s:update({0}, {{'&', 2, 40}}) -- err
---
- error: 'Argument type in operation ''&'' on field 2 does not match field type: expected
    a positive integer'
...
s:update({0}, {{'^', 2, 6}}) -- err
---
- error: 'Argument type in operation ''^'' on field 2 does not match field type: expected
    a positive integer'
...
s:replace{0, 1.5} -- 1.5
---
- [0, 1.5]
...
s:update({0}, {{'|', 2, 2}}) -- err
---
- error: 'Argument type in operation ''|'' on field 2 does not match field type: expected
    a positive integer'
...
s:update({0}, {{'&', 2, 40}}) -- err
---
- error: 'Argument type in operation ''&'' on field 2 does not match field type: expected
    a positive integer'
...
s:update({0}, {{'^', 2, 6}}) -- err
---
- error: 'Argument type in operation ''^'' on field 2 does not match field type: expected
    a positive integer'
...
-- double
s:replace{0, 5} -- 5
---
- [0, 5]
...
s:update({0}, {{'+', 2, 1.5}}) -- int + double = double 6.5
---
- [0, 6.5]
...
s:update({0}, {{'|', 2, 2}}) -- err (double!)
---
- error: 'Argument type in operation ''|'' on field 2 does not match field type: expected
    a positive integer'
...
s:update({0}, {{'-', 2, 0.5}}) -- double - double = double 6
---
- [0, 6]
...
s:update({0}, {{'+', 2, 1.5}}) -- double + double = double 7.5
---
- [0, 7.5]
...
-- float
s:replace{0, ffi.new("float", 1.5)} -- 1.5
---
- [0, 1.5]
...
s:update({0}, {{'+', 2, 2}}) -- float + int = float 3.5
---
- [0, 3.5]
...
s:update({0}, {{'+', 2, ffi.new("float", 3.5)}}) -- float + int = float 7
---
- [0, 7]
...
s:update({0}, {{'|', 2, 2}}) -- err (float!)
---
- error: 'Argument type in operation ''|'' on field 2 does not match field type: expected
    a positive integer'
...
s:update({0}, {{'-', 2, ffi.new("float", 1.5)}}) -- float - float = float 5.5
---
- [0, 5.5]
...
s:update({0}, {{'+', 2, ffi.new("float", 3.5)}}) -- float + float = float 9
---
- [0, 9]
...
s:update({0}, {{'-', 2, ffi.new("float", 9)}}) -- float + float = float 0
---
- [0, 0]
...
s:update({0}, {{'+', 2, ffi.new("float", 1.2)}}) -- float + float = float 1.2
---
- [0, 1.2000000476837]
...
-- decimal
decimal = require('decimal')
---
...
s:replace{0, decimal.new("2.000")}
---
- [0, 2.000]
...
s:update({0}, {{'+', 2, 2ULL}}) -- decimal + unsigned = decimal 4.000
---
- [0, 4.000]
...
s:update({0}, {{'+', 2, -4LL}}) -- decimal + signed = decimal 0.000
---
- [0, 0.000]
...
s:update({0}, {{'+', 2, 2}})  -- decimal + number = decimal 2.000
---
- [0, 2.000]
...
s:update({0}, {{'-', 2, 2}}) -- decimal - number = decimal 0.000
---
- [0, 0.000]
...
s:update({0}, {{'-', 2, ffi.new('float', 2)}}) -- decimal - float = decimal -2.000
---
- [0, -2.000]
...
s:update({0}, {{'-', 2, ffi.new('double', 2)}}) -- decimal - double = decimal -4.000
---
- [0, -4.000]
...
s:update({0}, {{'+', 2, decimal.new(4)}}) -- decimal + decimal = decimal 0.000
---
- [0, 0.000]
...
s:update({0}, {{'-', 2, decimal.new(2)}}) -- decimal - decimal = decimal -2.000
---
- [0, -2.000]
...
-- overflow --
s:replace{0, 0xfffffffffffffffeull}
---
- [0, 18446744073709551614]
...
s:update({0}, {{'+', 2, 1}}) -- ok
---
- [0, 18446744073709551615]
...
s:update({0}, {{'+', 2, 1}}) -- overflow
---
- error: Integer overflow when performing '+' operation on field 2
...
s:update({0}, {{'+', 2, 100500}}) -- overflow
---
- error: Integer overflow when performing '+' operation on field 2
...
s:replace{0, 1}
---
- [0, 1]
...
s:update({0}, {{'+', 2, 0xffffffffffffffffull}})  -- overflow
---
- error: Integer overflow when performing '+' operation on field 2
...
s:replace{0, -1}
---
- [0, -1]
...
s:update({0}, {{'+', 2, 0xffffffffffffffffull}})  -- ok
---
- [0, 18446744073709551614]
...
s:replace{0, 0}
---
- [0, 0]
...
s:update({0}, {{'-', 2, 0x7fffffffffffffffull}})  -- ok
---
- [0, -9223372036854775807]
...
s:replace{0, -1}
---
- [0, -1]
...
s:update({0}, {{'-', 2, 0x7fffffffffffffffull}})  -- ok
---
- [0, -9223372036854775808]
...
s:replace{0, -2}
---
- [0, -2]
...
s:update({0}, {{'-', 2, 0x7fffffffffffffffull}})  -- overflow
---
- error: Integer overflow when performing '-' operation on field 2
...
s:replace{0, 1}
---
- [0, 1]
...
s:update({0}, {{'-', 2, 0xffffffffffffffffull}})  -- overflow
---
- error: Integer overflow when performing '-' operation on field 2
...
s:replace{0, 0xffffffffffffffefull}
---
- [0, 18446744073709551599]
...
s:update({0}, {{'-', 2, -16}})  -- ok
---
- [0, 18446744073709551615]
...
s:update({0}, {{'-', 2, -16}})  -- overflow
---
- error: Integer overflow when performing '-' operation on field 2
...
s:replace{0, -0x4000000000000000ll}
---
- [0, -4611686018427387904]
...
s:update({0}, {{'+', 2, -0x4000000000000000ll}})  -- ok
---
- [0, -9223372036854775808]
...
s:replace{0, -0x4000000000000000ll}
---
- [0, -4611686018427387904]
...
s:update({0}, {{'+', 2, -0x4000000000000001ll}})  -- overflow
---
- error: Integer overflow when performing '+' operation on field 2
...
-- some wrong updates --
s:update({0}, 0)
---
- error: Usage index:update(key, ops)
...
s:update({0}, {'+', 2, 2})
---
- error: Illegal parameters, update operation must be an array {op,..}
...
s:update({0}, {{}})
---
- error: Illegal parameters, update operation must be an array {op,..}, got empty
    array
...
s:update({0}, {{'+'}})
---
- error: 'Unknown UPDATE operation #1: wrong number of arguments, expected 3, got
    1'
...
s:update({0}, {{'+', 0}})
---
- error: 'Unknown UPDATE operation #1: wrong number of arguments, expected 3, got
    2'
...
s:update({0}, {{'', 2, 1}})
---
- error: 'Unknown UPDATE operation #1: ""'
...
s:update({0}, {{'more than 1 character', 2, 1}})
---
- error: 'Unknown UPDATE operation #1: "more than 1 character"'
...
s:update({0}, {{'same as previous'}})
---
- error: 'Unknown UPDATE operation #1: "same as previous"'
...
s:update({0}, {{'+', '+', '+'}})
---
- error: 'Field ''+'' UPDATE error: invalid JSON in position 1'
...
s:update({0}, {{0, 0, 0}})
---
- error: Illegal parameters, update operation name must be a string
...
-- test for https://github.com/tarantool/tarantool/issues/1142
-- broken WAL during upsert
ops = {}
---
...
for i = 1,10 do table.insert(ops, {'=', 2, '1234567890'}) end
---
...
s:upsert({0}, ops)
---
...
-- https://github.com/tarantool/tarantool/issues/1854
s:get{0}
---
- [0, '1234567890']
...
s:update({0}, {})
---
- [0, '1234567890']
...
--#stop server default
--#start server default
s = box.space.tweedledum
---
...
--
-- gh-2036: msgpackffi doesn't support __serialize hint
--
map = setmetatable({}, { __serialize = 'map' })
---
...
t = box.tuple.new({1, 2, 3})
---
...
s:replace({1, 2, 3})
---
- [1, 2, 3]
...
t:update({{'=', 3, map}})
---
- [1, 2, {}]
...
s:update(1, {{'=', 3, map}})
---
- [1, 2, {}]
...
s:drop()
---
...
--
-- gh-1261: update by JSON path.
--
format = {}
---
...
format[1] = {'field1', 'unsigned'}
---
...
format[2] = {'f', 'map'}
---
...
format[3] = {'g', 'array'}
---
...
s = box.schema.create_space('test', {format = format})
---
...
pk = s:create_index('pk')
---
...
t = {}
---
...
t[1] = 1
---
...
t[2] = {                            \
    a = 100,                        \
    b = 200,                        \
    c = {                           \
        d = 400,                    \
        e = 500,                    \
        f = {4, 5, 6, 7, 8},        \
        g = {k = 600, l = 700}      \
    },                              \
    m = true,                       \
    g = {800, 900}                  \
};                                  \
t[3] = {                            \
    100,                            \
    200,                            \
    {                               \
        {300, 350},                 \
        {400, 450}                  \
    },                              \
    {a = 500, b = 600},             \
    {c = 700, d = 800}              \
}
---
...
t = s:insert(t)
---
...
t4_array = t:update({{'!', 4, setmetatable({}, {__serialize = 'array'})}})
---
...
t4_map = t:update({{'!', 4, setmetatable({}, {__serialize = 'map'})}})
---
...
t
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
--
-- At first, test simple non-intersected paths.
--
--
-- !
--
t:update({{'!', 'f.c.f[1]', 3}, {'!', '[3][1]', {100, 200, 300}}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [3, 4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [[100, 200, 300], 100, 200, [
      [300, 350], [400, 450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'!', 'f.g[3]', 1000}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900, 1000]}, [100, 200, [[300, 350],
      [400, 450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'!', 'g[6]', 'new element'}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}, 'new element']]
...
t:update({{'!', 'f.e', 300}, {'!', 'g[4].c', 700}})
---
- [1, {'b': 200, 'm': true, 'g': [800, 900], 'a': 100, 'c': {'d': 400, 'f': [4, 5,
        6, 7, 8], 'e': 500, 'g': {'k': 600, 'l': 700}}, 'e': 300}, [100, 200, [[300,
        350], [400, 450]], {'b': 600, 'c': 700, 'a': 500}, {'c': 700, 'd': 800}]]
...
t:update({{'!', 'f.c.f[2]', 4.5}, {'!', 'g[3][2][2]', 425}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 4.5, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        425, 450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t2 = t:update({{'!', 'g[6]', {100}}})
---
...
-- Test single element array update.
t2:update({{'!', 'g[6][2]', 200}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}, [100, 200]]]
...
t2:update({{'!', 'g[6][1]', 50}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}, [50, 100]]]
...
-- Test empty array/map.
t4_array:update({{'!', '[4][1]', 100}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}], [100]]
...
t4_map:update({{'!', '[4].a', 100}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}], {'a': 100}]
...
-- Test errors.
ops = {{'!', 'a', 100}} -- No such field.
---
...
t:update(ops)
---
- error: Field 'a' was not found in the tuple
...
t:upsert(ops)
---
- error: Field 'a' was not found in the tuple
...
ops = {{'!', 'f.a', 300}} -- Key already exists.
---
...
t:update(ops)
---
- error: 'Field ''f.a'' UPDATE error: the key exists already'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'!', 'f.c.f[0]', 3.5}} -- No such index, too small.
---
...
t:update(ops)
---
- error: 'Field ''f.c.f[0]'' UPDATE error: invalid JSON in position 7'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'!', 'f.c.f[100]', 100}} -- No such index, too big.
---
...
t:update(ops)
---
- error: Field ''f.c.f[100]'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'!', 'g[4][100]', 700}} -- Insert index into map.
---
...
t:update(ops)
---
- error: 'Field ''g[4][100]'' UPDATE error: can not access by index a non-array field'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'!', 'g[1][1]', 300}}
---
...
t:update(ops)
---
- error: 'Field ''g[1][1]'' UPDATE error: can not access by index a non-array field'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'!', 'f.g.a', 700}} -- Insert key into array.
---
...
t:update(ops)
---
- error: 'Field ''f.g.a'' UPDATE error: can not access by key a non-map field'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'!', 'f.g[1].a', 700}}
---
...
t:update(ops)
---
- error: 'Field ''f.g[1].a'' UPDATE error: can not access by key a non-map field'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'!', 'f[*].k', 20}} -- 'Any' is not considered valid JSON.
---
...
t:update(ops)
---
- error: 'Field ''f[*].k'' UPDATE error: invalid JSON in position 3'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
-- JSON error after the not existing field to insert.
ops = {{'!', '[2].e.100000', 100}}
---
...
t:update(ops)
---
- error: 'Field ''[2].e.100000'' UPDATE error: invalid JSON in position 7'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
-- Correct JSON, but next to last field does not exist. '!' can't
-- create the whole path.
ops = {{'!', '[2].e.f', 100}}
---
...
t:update(ops)
---
- error: Field ''[2].e.f'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
--
-- =
--
-- Set existing fields.
t:update({{'=', 'f.a', 150}, {'=', 'g[3][1][2]', 400}})
---
- [1, {'b': 200, 'm': true, 'a': 150, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 400], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'=', 'f', {a = 100, b = 200}}})
---
- [1, {'a': 100, 'b': 200}, [100, 200, [[300, 350], [400, 450]], {'a': 500, 'b': 600},
    {'c': 700, 'd': 800}]]
...
t:update({{'=', 'g[4].b', 700}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 700}, {'c': 700, 'd': 800}]]
...
-- Insert via set.
t:update({{'=', 'f.e', 300}})
---
- [1, {'b': 200, 'm': true, 'g': [800, 900], 'a': 100, 'c': {'d': 400, 'f': [4, 5,
        6, 7, 8], 'e': 500, 'g': {'k': 600, 'l': 700}}, 'e': 300}, [100, 200, [[300,
        350], [400, 450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'=', 'f.g[3]', 1000}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900, 1000]}, [100, 200, [[300, 350],
      [400, 450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'=', 'f.g[1]', 0}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [0, 900]}, [100, 200, [[300, 350], [400, 450]],
    {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
-- Test empty array/map.
t4_array:update({{'=', '[4][1]', 100}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}], [100]]
...
t4_map:update({{'=', '[4]["a"]', 100}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}], {'a': 100}]
...
-- Test errors.
ops = {{'=', 'f.a[1]', 100}}
---
...
t:update(ops)
---
- error: 'Field ''f.a[1]'' UPDATE error: can not access by index a non-array field'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'=', 'f.a.k', 100}}
---
...
t:update(ops)
---
- error: 'Field ''f.a.k'' UPDATE error: can not access by key a non-map field'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'=', 'f.c.f[1]', 100}}
---
...
t:update(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [100, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [100, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'=', 'f.c.f[100]', 100}}
---
...
t:update(ops)
---
- error: Field ''f.c.f[100]'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'=', '[2].c.f 1 1 1 1', 100}}
---
...
t:update(ops)
---
- error: 'Field ''[2].c.f 1 1 1 1'' UPDATE error: invalid JSON in position 8'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
--
-- #
--
t:update({{'#', '[2].b', 1}})
---
- [1, {'a': 100, 'm': true, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500, 'g': {
        'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400, 450]],
    {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'#', 'f.c.f[1]', 1}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'#', 'f.c.f[1]', 2}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [6, 7, 8], 'e': 500, 'g': {
        'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400, 450]],
    {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'#', 'f.c.f[1]', 100}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [], 'e': 500, 'g': {'k': 600,
        'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400, 450]], {'a': 500,
      'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'#', 'f.c.f[5]', 1}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'#', 'f.c.f[5]', 2}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
-- Test errors.
ops = {{'#', 'f.h', 1}}
---
...
t:update(ops)
---
- error: Field ''f.h'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'#', 'f.c.f[100]', 1}}
---
...
t:update(ops)
---
- error: Field ''f.c.f[100]'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'#', 'f.b', 2}}
---
...
t:update(ops)
---
- error: 'Field ''f.b'' UPDATE error: can delete only 1 field from a map in a row'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'#', 'f.b', 0}}
---
...
t:update(ops)
---
- error: 'Field ''f.b'' UPDATE error: cannot delete 0 fields'
...
t:upsert(ops)
---
- error: 'Field ''f.b'' UPDATE error: cannot delete 0 fields'
...
ops = {{'#', 'f', 0}}
---
...
t:update(ops)
---
- error: 'Field ''f'' UPDATE error: cannot delete 0 fields'
...
t:upsert(ops)
---
- error: 'Field ''f'' UPDATE error: cannot delete 0 fields'
...
--
-- Scalar operations.
--
t:update({{'+', 'f.a', 50}})
---
- [1, {'b': 200, 'm': true, 'a': 150, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'-', 'f.c.f[1]', 0.5}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [3.5, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t:update({{'&', 'f.c.f[2]', 4}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 4, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t2 = t:update({{'=', 4, {str = 'abcd'}}})
---
...
t2:update({{':', '[4].str', 2, 2, 'e'}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}], {'str': 'aed'}]
...
-- Test errors.
ops = {{'+', 'g[3]', 50}}
---
...
t:update(ops)
---
- error: 'Argument type in operation ''+'' on field ''g[3]'' does not match field
    type: expected a number'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'+', '[2].b.......', 100}}
---
...
t:update(ops)
---
- error: 'Field ''[2].b.......'' UPDATE error: invalid JSON in position 7'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'+', '[2].b.c.d.e', 100}}
---
...
t:update(ops)
---
- error: Field ''[2].b.c.d.e'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
ops = {{'-', '[2][*]', 20}}
---
...
t:update(ops)
---
- error: 'Field ''[2][*]'' UPDATE error: invalid JSON in position 5'
...
t:upsert(ops)
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
-- Vinyl normalizes field numbers. It should not touch paths,
-- and they should not affect squashing.
format = {}
---
...
format[1] = {'field1', 'unsigned'}
---
...
format[2] = {'field2', 'any'}
---
...
vy_s = box.schema.create_space('test2', {engine = 'vinyl', format = format})
---
...
pk = vy_s:create_index('pk')
---
...
_ = vy_s:replace(t)
---
...
box.begin()
---
...
-- Use a scalar operation, only they can be squashed.
vy_s:upsert({1, 1}, {{'+', 'field2.c.f[1]', 1}})
---
...
vy_s:upsert({1, 1}, {{'+', '[3][3][1][1]', 1}})
---
...
box.commit()
---
...
vy_s:select()
---
- - [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [5, 5, 6, 7, 8], 'e': 500,
        'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[301, 350], [400,
          450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
vy_s:drop()
---
...
--
-- Complex updates. Intersected paths, different types.
--
--
-- =
--
-- Difference in the last part.
t:update({{'=', '[3][3][1][1]', 325}, {'=', '[3][3][1][2]', 375}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[325, 375], [400,
        450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
-- Different starting from the non-last part.
t:update({{'=', '[3][3][1][1]', 325}, {'=', '[3][3][2][2]', 475}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4, 5, 6, 7, 8], 'e': 500,
      'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[325, 350], [400,
        475]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
-- Contains string keys in the middle.
t:update({{'=', '[2].c.f[1]', 4000}, {'=', '[2].c.f[2]', 5000}})
---
- [1, {'b': 200, 'm': true, 'a': 100, 'c': {'d': 400, 'f': [4000, 5000, 6, 7, 8],
      'e': 500, 'g': {'k': 600, 'l': 700}}, 'g': [800, 900]}, [100, 200, [[300, 350],
      [400, 450]], {'a': 500, 'b': 600}, {'c': 700, 'd': 800}]]
...
t = {1}
---
...
t[2] = setmetatable({}, {__serialize = 'map'})
---
...
t[3] = {}
---
...
t[4] = {                        \
    1,                          \
    2,                          \
    3,                          \
    {                           \
        4,                      \
        5,                      \
        6,                      \
        7,                      \
        {                       \
            8,                  \
            9,                  \
            {10, 11, 12},       \
            13,                 \
            14,                 \
        },                      \
        15,                     \
        16,                     \
        {17, 18, 19}            \
    },                          \
    20,                         \
    {                           \
        a = 21,                 \
        b = 22,                 \
        c = {                   \
            d = 23,             \
            e = 24              \
        }                       \
    },                          \
    25                          \
}
---
...
t = s:replace(t)
---
...
-- Non-first and non-last field updates.
t:update({{'=', '[4][4][5][3][2]', 11000}, {'=', '[4][4][8][3]', 19000}})
---
- [1, {}, [], [1, 2, 3, [4, 5, 6, 7, [8, 9, [10, 11000, 12], 13, 14], 15, 16, [17,
        18, 19000]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
-- Triple intersection with enabled fast jump by route.
t:update({{'=', '[4][4][3]', 6000}, {'=', '[4][4][5][2]', 9000}, {'=', '[4][4][8][2]', 18000}})
---
- [1, {}, [], [1, 2, 3, [4, 5, 6000, 7, [8, 9000, [10, 11, 12], 13, 14], 15, 16, [
        17, 18000, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
-- Triple intersection with no optimizations.
t:update({{'=', '[4][3]', 3000}, {'=', '[4][4][2]', 5000}, {'=', '[4][4][5][1]', 8000}})
---
- [1, {}, [], [1, 2, 3000, [4, 5000, 6, 7, [8000, 9, [10, 11, 12], 13, 14], 15, 16,
      [17, 18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
-- Last operation splits previous ones.
t:update({{'=', '[4][4][5][3][2]', 11000}, {'=', '[4][4][5][3][1]', 10000}, {'=', '[4][4][3]', 6000}})
---
- [1, {}, [], [1, 2, 3, [4, 5, 6000, 7, [8, 9, [10000, 11000, 12], 13, 14], 15, 16,
      [17, 18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
-- First two operations generate a route '[4]' in the 4th field of
-- the tuple. With childs [1] and [2]. The last operation should
-- delete the route and replace it with a full featured array.
t:update({{'=', '[4][4][1]', 4.5}, {'=', '[4][4][2]', 5.5}, {'=', '[4][3]', 3.5}})
---
- [1, {}, [], [1, 2, 3.5, [4.5, 5.5, 6, 7, [8, 9, [10, 11, 12], 13, 14], 15, 16, [
        17, 18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
-- Test errors.
ops = {{'=', '[4][4][5][1]', 8000}, {'=', '[4][4][5].a', -1}}
---
...
t:update(ops)
---
- error: 'Field ''[4][4][5].a'' UPDATE error: can not update array by non-integer
    index'
...
t:upsert(ops)
---
- [1, {}, [], [1, 2, 3, [4, 5, 6, 7, [8000, 9, [10, 11, 12], 13, 14], 15, 16, [17,
        18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
ops = {{'=', '[4][4][5][1]', 8000}, {'=', '[4][4][*].a', -1}}
---
...
t:update(ops)
---
- error: 'Field ''[4][4][*].a'' UPDATE error: can not update array by non-integer
    index'
...
t:upsert(ops)
---
- [1, {}, [], [1, 2, 3, [4, 5, 6, 7, [8000, 9, [10, 11, 12], 13, 14], 15, 16, [17,
        18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
ops = {{'=', '[4][4][*].b', 8000}, {'=', '[4][4][*].a', -1}}
---
...
t:update(ops)
---
- error: 'Field ''[4][4][*].b'' UPDATE error: invalid JSON in position 8'
...
t:upsert(ops)
---
- [1, {}, [], [1, 2, 3, [4, 5, 6, 7, [8, 9, [10, 11, 12], 13, 14], 15, 16, [17, 18,
        19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
ops = {{'=', '[4][4][1]', 4000}, {'=', '[4][4]-badjson', -1}}
---
...
t:update(ops)
---
- error: 'Field ''[4][4]-badjson'' UPDATE error: invalid JSON in position 7'
...
t:upsert(ops)
---
- [1, {}, [], [1, 2, 3, [4000, 5, 6, 7, [8, 9, [10, 11, 12], 13, 14], 15, 16, [17,
        18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
ops = {{'=', '[4][4][1]', 1}, {'=', '[4][4][1]', 2}}
---
...
t:update(ops)
---
- error: 'Field ''[4][4][1]'' UPDATE error: double update of the same field'
...
t:upsert(ops)
---
- [1, {}, [], [1, 2, 3, [1, 5, 6, 7, [8, 9, [10, 11, 12], 13, 14], 15, 16, [17, 18,
        19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
-- First two operations produce zero length bar update in field
-- [4][4][5][4]. The third operation should raise an error.
ops = {{'+', '[4][4][5][4]', 13000}, {'=', '[4][4][5][1]', 8000}, {'+', '[4][4][5][4]', 1}}
---
...
t:update(ops)
---
- error: 'Field ''[4][4][5][4]'' UPDATE error: double update of the same field'
...
t:upsert(ops)
---
- [1, {}, [], [1, 2, 3, [4, 5, 6, 7, [8000, 9, [10, 11, 12], 13013, 14], 15, 16, [
        17, 18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
--
-- !
--
t:update({{'!', '[4][5]', 19.5}, {'!', '[4][6]', 19.75}, {'!', '[4][4][3]', 5.5}, {'=', '[4][4][2]', 5.25}})
---
- [1, {}, [], [1, 2, 3, [4, 5.25, 5.5, 6, 7, [8, 9, [10, 11, 12], 13, 14], 15, 16,
      [17, 18, 19]], 19.5, 19.75, 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}},
    25]]
...
--
-- #
--
t:update({{'#', '[4][4][5]', 1}, {'#', '[4][4][4]', 1}, {'#', '[4][4][5]', 1}})
---
- [1, {}, [], [1, 2, 3, [4, 5, 6, 15, [17, 18, 19]], 20, {'b': 22, 'a': 21, 'c': {
        'd': 23, 'e': 24}}, 25]]
...
--
-- Scalar operations.
--
t:update({{'+', '[4][3]', 0.5}, {'+', '[4][4][5][5]', 0.75}})
---
- [1, {}, [], [1, 2, 3.5, [4, 5, 6, 7, [8, 9, [10, 11, 12], 13, 14.75], 15, 16, [
        17, 18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
t:update({{'+', '[4][3]', 0.5}, {'+', '[4][4][5][5]', 0.75}, {'+', '[4][4][3]', 0.25}})
---
- [1, {}, [], [1, 2, 3.5, [4, 5, 6.25, 7, [8, 9, [10, 11, 12], 13, 14.75], 15, 16,
      [17, 18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
-- Combined - check that operations following '!' take into
-- account that there is a new element. Indexes should be relative
-- to the new array size.
t:update({{'!', '[4][3]', 2.5}, {'+', '[4][5][5][5]', 0.75}, {'+', '[4][5][3]', 0.25}})
---
- [1, {}, [], [1, 2, 2.5, 3, [4, 5, 6.25, 7, [8, 9, [10, 11, 12], 13, 14.75], 15,
      16, [17, 18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
-- Error - an attempt to follow JSON path in a scalar field
-- during branching.
ops = {{'+', '[4][3]', 0.5}, {'+', '[4][3][2]', 0.5}}
---
...
t:update(ops)
---
- error: Field ''[4][3][2]'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {}, [], [1, 2, 3.5, [4, 5, 6, 7, [8, 9, [10, 11, 12], 13, 14], 15, 16, [17,
        18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
-- Error - array update should check that its token is a number.
-- Parent field won't guarantee that.
ops = {{'=', '[3]', {0}}, {'=', '[4][3]', 3.5}, {'=', '[4][4][1]', 4.5}, {'=', '[4][4][2]', 5.5}, {'=', '[4][4].key', 6.5}}
---
...
t:update(ops)
---
- error: 'Field ''[4][4].key'' UPDATE error: can''t update an array by a non-numeric
    index'
...
t:upsert(ops)
---
- [1, {}, [0], [1, 2, 3.5, [4.5, 5.5, 6, 7, [8, 9, [10, 11, 12], 13, 14], 15, 16,
      [17, 18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
--
-- Intersecting map updates.
--
t:update({{'=', '[4][6].c.d', 2300}, {'=', '[4][6].c.e', 2400}})
---
- [1, {}, [], [1, 2, 3, [4, 5, 6, 7, [8, 9, [10, 11, 12], 13, 14], 15, 16, [17, 18,
        19]], 20, {'b': 22, 'a': 21, 'c': {'d': 2300, 'e': 2400}}, 25]]
...
-- Fill an empty map.
t:update({{'=', '[2].k', 100}, {'=', '[2].v', 200}})
---
- [1, {'k': 100, 'v': 200}, [], [1, 2, 3, [4, 5, 6, 7, [8, 9, [10, 11, 12], 13, 14],
      15, 16, [17, 18, 19]], 20, {'b': 22, 'a': 21, 'c': {'d': 23, 'e': 24}}, 25]]
...
t = {}                                  \
t[1] = 1                                \
t[2] = {                                \
    a = 1,                              \
    b = 2,                              \
    c = {3, 4, 5},                      \
    d = {                               \
        [0] = 0,                        \
        e = 6,                          \
        [true] = false,                 \
        f = 7,                          \
        [-1] = -1,                      \
    },                                  \
    g = {                               \
        {k = 8, v = 9},                 \
        [box.NULL] = box.NULL,          \
        {k = 10, v = 11},               \
        {k = '12str', v = '13str'},     \
    },                                  \
    h = {                               \
        [-1] = {{{{-1}, -1}, -1}, -1},  \
        i = {                           \
            j = 14,                     \
            k = 15,                     \
        },                              \
        m = 16,                         \
    }                                   \
}
---
...
t[3] = {}
---
...
t = box.tuple.new(t)
---
...
-- Insert and delete from the same map at once.
t:update({{'!', '[2].n', 17}, {'#', '[2].b', 1}})
---
- [1, {'a': 1, 'n': 17, 'd': {0: 0, -1: -1, true: false, 'f': 7, 'e': 6}, 'h': {'i': {
        'j': 14, 'k': 15}, -1: [[[[-1], -1], -1], -1], 'm': 16}, 'c': [3, 4, 5], 'g': {
      1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
-- Delete a not existing key.
t:update({{'=', '[2].d.g', 6000}, {'#', '[2].d.old', 1}})
---
- [1, {'b': 2, 'a': 1, 'd': {0: 0, 'f': 7, 'e': 6, -1: -1, true: false, 'g': 6000},
    'h': {'i': {'j': 14, 'k': 15}, -1: [[[[-1], -1], -1], -1], 'm': 16}, 'c': [3,
      4, 5], 'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
-- Scalar operations.
t:update({{'+', '[2].d.e', 1}, {'+', '[2].b', 1}, {'+', '[2].d.f', 1}})
---
- [1, {'b': 3, 'c': [3, 4, 5], 'd': {0: 0, true: false, 'f': 8, -1: -1, 'e': 7}, 'h': {
      'i': {'j': 14, 'k': 15}, -1: [[[[-1], -1], -1], -1], 'm': 16}, 'a': 1, 'g': {
      1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
-- Errors.
-- This operation array creates an update tree with several full
-- featured maps, not bars. It is required to cover some complex
-- cases about fields extraction.
ops = {{'=', '[2].h.i.j', 14000}, {'=', '[2].h.i.k', 15000}, {'=', '[2].h.m', 16000}, {'=', '[2].b', 2000}, {}}
---
...
-- When a map update extracts a next token on demand, it should
-- reject bad json, obviously. Scalar and '!'/'#' operations are
-- implemented separately and tested both.
ops[#ops] = {'+', '[2].h.i.<badjson>', -1}
---
...
t:update(ops)
---
- error: 'Field ''[2].h.i.<badjson>'' UPDATE error: invalid JSON in position 9'
...
t:upsert(ops)
---
- [1, {'b': 2000, 'c': [3, 4, 5], 'd': {0: 0, -1: -1, true: false, 'f': 7, 'e': 6},
    'h': {'i': {'k': 15000, 'j': 14000}, 'm': 16000, -1: [[[[-1], -1], -1], -1]},
    'a': 1, 'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
ops[#ops][1] = '!'
---
...
t:update(ops)
---
- error: 'Field ''[2].h.i.<badjson>'' UPDATE error: invalid JSON in position 9'
...
t:upsert(ops)
---
- [1, {'b': 2000, 'c': [3, 4, 5], 'd': {0: 0, -1: -1, true: false, 'f': 7, 'e': 6},
    'h': {'i': {'k': 15000, 'j': 14000}, 'm': 16000, -1: [[[[-1], -1], -1], -1]},
    'a': 1, 'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
ops[#ops][1] = '#'
---
...
ops[#ops][3] = 1
---
...
t:update(ops)
---
- error: 'Field ''[2].h.i.<badjson>'' UPDATE error: invalid JSON in position 9'
...
t:upsert(ops)
---
- [1, {'b': 2000, 'c': [3, 4, 5], 'd': {0: 0, -1: -1, true: false, 'f': 7, 'e': 6},
    'h': {'i': {'k': 15000, 'j': 14000}, 'm': 16000, -1: [[[[-1], -1], -1], -1]},
    'a': 1, 'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
-- Key extractor should reject any attempt to use non-string keys.
ops[#ops] = {'-', '[2].h.i[20]', -1}
---
...
t:update(ops)
---
- error: 'Field ''[2].h.i[20]'' UPDATE error: can''t update a map by not a string
    key'
...
t:upsert(ops)
---
- [1, {'b': 2000, 'c': [3, 4, 5], 'd': {0: 0, -1: -1, true: false, 'f': 7, 'e': 6},
    'h': {'i': {'k': 15000, 'j': 14000}, 'm': 16000, -1: [[[[-1], -1], -1], -1]},
    'a': 1, 'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
ops[#ops][1] = '='
---
...
t:update(ops)
---
- error: 'Field ''[2].h.i[20]'' UPDATE error: can''t update a map by not a string
    key'
...
t:upsert(ops)
---
- [1, {'b': 2000, 'c': [3, 4, 5], 'd': {0: 0, -1: -1, true: false, 'f': 7, 'e': 6},
    'h': {'i': {'k': 15000, 'j': 14000}, 'm': 16000, -1: [[[[-1], -1], -1], -1]},
    'a': 1, 'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
ops = {{'+', '[2].d.e', 1}, {'+', '[2].d.f', 1}, {'+', '[2].d.k', 1}}
---
...
t:update(ops)
---
- error: Field ''[2].d.k'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {'b': 2, 'a': 1, 'd': {0: 0, true: false, 'f': 8, -1: -1, 'e': 7}, 'h': {'i': {
        'j': 14, 'k': 15}, -1: [[[[-1], -1], -1], -1], 'm': 16}, 'c': [3, 4, 5], 'g': {
      1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
ops = {{'=', '[2].d.e', 6000}, {'!', '[2].d.g.h', -1}}
---
...
t:update(ops)
---
- error: Field ''[2].d.g.h'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {'b': 2, 'a': 1, 'd': {0: 0, 'f': 7, -1: -1, true: false, 'e': 6000}, 'h': {
      'i': {'j': 14, 'k': 15}, -1: [[[[-1], -1], -1], -1], 'm': 16}, 'c': [3, 4, 5],
    'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
ops = {{'!', '[2].d.g', 6000}, {'!', '[2].d.e', -1}}
---
...
t:update(ops)
---
- error: 'Field ''[2].d.e'' UPDATE error: the key exists already'
...
t:upsert(ops)
---
- [1, {'b': 2, 'a': 1, 'd': {0: 0, true: false, 'f': 7, -1: -1, 'e': 6, 'g': 6000},
    'h': {'i': {'j': 14, 'k': 15}, -1: [[[[-1], -1], -1], -1], 'm': 16}, 'c': [3,
      4, 5], 'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
ops = {{'=', '[2].d.g', 6000}, {'#', '[2].d.old', 10}}
---
...
t:update(ops)
---
- error: 'Field ''[2].d.old'' UPDATE error: can delete only 1 field from a map in
    a row'
...
t:upsert(ops)
---
- [1, {'b': 2, 'a': 1, 'd': {0: 0, 'f': 7, 'e': 6, -1: -1, true: false, 'g': 6000},
    'h': {'i': {'j': 14, 'k': 15}, -1: [[[[-1], -1], -1], -1], 'm': 16}, 'c': [3,
      4, 5], 'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
-- '!'/'=' can be used to create a field, but only if it is a
-- tail. These operations can't create the whole path.
ops = {{'=', '[2].d.g', 6000}, {'=', '[2].d.new.new', -1}}
---
...
t:update(ops)
---
- error: Field ''[2].d.new.new'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {'b': 2, 'a': 1, 'd': {0: 0, 'f': 7, 'e': 6, -1: -1, true: false, 'g': 6000},
    'h': {'i': {'j': 14, 'k': 15}, -1: [[[[-1], -1], -1], -1], 'm': 16}, 'c': [3,
      4, 5], 'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
ops = {{'=', '[2].d.g', 6000}, {'#', '[2].d.old.old', 1}}
---
...
t:update(ops)
---
- error: Field ''[2].d.old.old'' was not found in the tuple
...
t:upsert(ops)
---
- [1, {'b': 2, 'a': 1, 'd': {0: 0, 'f': 7, 'e': 6, -1: -1, true: false, 'g': 6000},
    'h': {'i': {'j': 14, 'k': 15}, -1: [[[[-1], -1], -1], -1], 'm': 16}, 'c': [3,
      4, 5], 'g': {1: {'k': 8, 'v': 9}, 2: {'k': 10, 'v': 11}, 3: {'k': '12str', 'v': '13str'},
      null: null}}, []]
...
s:drop()
---
...
--
-- gh-4701: arith operations should not truncate result when
-- float + float fits double.
--
msgpackffi = require('msgpackffi')
---
...
mp_array_1 = 0x91
---
...
mp_double = 0xcb
---
...
mp_float = 0xca
---
...
flt_max = 3.402823466e+38
---
...
uint_max = 18446744073709551615ULL
---
...
-- Double + double is float if result fits.                                     \
-- Double + double is double if result does not fit float.                      \
-- Double + float is float if result fits.                                      \
-- Double + float is double if result does not fit float.                       \
-- Float + float is float when no overflow.                                     \
-- Float + float is double when overflow.                                       \
-- Float + int is float when fits the float range.                              \
-- Precision matters too. Double is used when need to avoid                     \
-- precision loss.                                                              \
tests = {                                                                       \
    {{'double', 1}, {'double', 1}, mp_float},                                   \
    {{'double', flt_max}, {'double', flt_max}, mp_double},                      \
    {{'double', 1}, {'float', 1}, mp_float},                                    \
    {{'double', flt_max}, {'float', flt_max}, mp_double},                       \
    {{'float', 1}, {'float', 1}, mp_float},                                     \
    {{'float', flt_max}, {'float', flt_max}, mp_double},                        \
    {{'float', -flt_max}, {'float', -flt_max}, mp_double},                      \
    {{'float', 1}, {'int', 1}, mp_float},                                       \
    {{'float', flt_max}, {'uint64_t', uint_max}, mp_float},                     \
    {{'float', 1.0001}, {'double', 1.0000000000001}, mp_double},                \
}
---
...
err = nil
---
...
for i, test in pairs(tests) do                                                  \
    local val1 = ffi.cast(test[1][1], test[1][2])                               \
    local val2 = ffi.cast(test[2][1], test[2][2])                               \
    local t = box.tuple.new({val1})                                             \
    t = t:update({{'+', 1, val2}})                                              \
    local m = msgpackffi.encode(t)                                              \
    if m:byte(1) ~= mp_array_1 or m:byte(2) ~= test[3] then                     \
        err = {i, test, t, m:byte(1), m:byte(2)}                                   \
        break                                                                   \
    end                                                                         \
end
---
...
err
---
- null
...
-- Check that if a field has 'double' field type, it won't use
-- float, even when the value fits float range.
s = box.schema.create_space('test', {                                           \
    format = {{'field1', 'unsigned'}, {'field2', 'double'}, {'field3', 'any'}}  \
})
---
...
_ = s:create_index('pk')
---
...
dbl1 = ffi.cast('double', 1)
---
...
_ = s:replace{1, dbl1, 1}
---
...
s:update({1}, {{'+', 2, dbl1}})
---
- [1, 2, 1]
...
_ = s:delete{1}
---
...
-- Check deep fields.
_ = s:create_index('deep_sk', {'field3', 'double', path = '[1].key1.key2[2]'})
---
- error: Illegal parameters, unexpected option '1'
...
_ = s:replace{1, dbl1, {{key1 = {key2 = {1, dbl1}}}}}
---
...
s:update({1}, {{'+', 'field3[1].key1.key2[2]', dbl1}})
---
- [1, 1, [{'key1': {'key2': [1, 2]}}]]
...
s:drop()
---
...
--
-- gh-6069: update of an absent field could crash when had 2 operations in
-- reversed order both on not specified fields.
--
box.tuple.new({1}):update({{'=', 4, 4}, {'=', 3, 3}})
---
- [1, null, 3, 4]
...
