wa = require 'sqlworkaround'
---
...
test_run = require('test_run').new()
---
...
-- test invalid input
wa.sql_schema_put(0, "invalid", 1, "CREATE FROB")
---
- 11
- 'malformed database schema (invalid) - near "FROB": syntax error'
...
-- create space
foobar = box.schema.space.create("foobar")
---
...
_ = foobar:create_index("primary",{parts={1,"number"}})
---
...
foobar_pageno = wa.sql_pageno(foobar.id, foobar.index.primary.id)
---
...
foobar_sql = "CREATE TABLE foobar (foo PRIMARY KEY, bar) WITHOUT ROWID"
---
...
wa.sql_schema_put(0, "foobar", foobar_pageno, foobar_sql)
---
- 0
- null
...
wa.sql_schema_put(0, "sqlite_autoindex_foobar_1", foobar_pageno, "")
---
- 0
- null
...
-- prepare data
box.sql.execute("INSERT INTO foobar VALUES (1, 'foo')")
---
...
box.sql.execute("INSERT INTO foobar VALUES (2, 'bar')")
---
...
box.sql.execute("INSERT INTO foobar VALUES (1000, 'foobar')")
---
...
box.sql.execute("INSERT INTO foobar VALUES (1, 'duplicate')")
---
- error: 'UNIQUE constraint failed: foobar.foo'
...
-- simple select
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar")
---
- - ['foo', 1, 42, 'awesome']
  - ['bar', 2, 42, 'awesome']
  - ['foobar', 1000, 42, 'awesome']
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar LIMIT 2")
---
- - ['foo', 1, 42, 'awesome']
  - ['bar', 2, 42, 'awesome']
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar WHERE foo=2")
---
- - ['bar', 2, 42, 'awesome']
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar WHERE foo>2")
---
- - ['foobar', 1000, 42, 'awesome']
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar WHERE foo>=2")
---
- - ['bar', 2, 42, 'awesome']
  - ['foobar', 1000, 42, 'awesome']
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar WHERE foo=10000")
---
- []
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar WHERE foo>10000")
---
- []
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar WHERE foo<2")
---
- - ['foo', 1, 42, 'awesome']
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar WHERE foo<2.001")
---
- - ['foo', 1, 42, 'awesome']
  - ['bar', 2, 42, 'awesome']
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar WHERE foo<=2")
---
- - ['foo', 1, 42, 'awesome']
  - ['bar', 2, 42, 'awesome']
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar WHERE foo<100")
---
- - ['foo', 1, 42, 'awesome']
  - ['bar', 2, 42, 'awesome']
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar WHERE bar='foo'")
---
- - ['foo', 1, 42, 'awesome']
...
box.sql.execute("SELECT count(*) FROM foobar")
---
- - [3]
...
box.sql.execute("SELECT count(*) FROM foobar WHERE bar='foo'")
---
- - [1]
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar ORDER BY bar")
---
- - ['bar', 2, 42, 'awesome']
  - ['foo', 1, 42, 'awesome']
  - ['foobar', 1000, 42, 'awesome']
...
box.sql.execute("SELECT bar, foo, 42, 'awesome' FROM foobar ORDER BY bar DESC")
---
- - ['foobar', 1000, 42, 'awesome']
  - ['foo', 1, 42, 'awesome']
  - ['bar', 2, 42, 'awesome']
...
-- updates
box.sql.execute("REPLACE INTO foobar VALUES (1, 'cacodaemon')")
---
...
box.sql.execute("SELECT COUNT(*) FROM foobar WHERE foo=1")
---
- - [1]
...
box.sql.execute("SELECT COUNT(*) FROM foobar WHERE bar='cacodaemon'")
---
- - [1]
...
box.sql.execute("DELETE FROM foobar WHERE bar='cacodaemon'")
---
...
box.sql.execute("SELECT COUNT(*) FROM foobar WHERE bar='cacodaemon'")
---
- - [0]
...
-- cleanup
foobar:drop()
---
...
-- multi-index
-- create space
barfoo = box.schema.space.create("barfoo")
---
...
_ = barfoo:create_index("primary",{parts={2,"number"}})
---
...
_ = barfoo:create_index("secondary",{parts={1,"string"}})
---
...
barfoo_pageno = wa.sql_pageno(barfoo.id, barfoo.index.primary.id)
---
...
barfoo2_pageno = wa.sql_pageno(barfoo.id, barfoo.index.secondary.id)
---
...
barfoo_sql = "CREATE TABLE barfoo (bar, foo PRIMARY KEY) WITHOUT ROWID"
---
...
wa.sql_schema_put(0, "barfoo", barfoo_pageno, barfoo_sql)
---
- 0
- null
...
wa.sql_schema_put(0, "sqlite_autoindex_barfoo_1", barfoo_pageno, "")
---
- 0
- null
...
wa.sql_schema_put(0, "barfoo2", barfoo2_pageno, "CREATE INDEX barfoo2 ON barfoo(bar)")
---
- 0
- null
...
-- prepare data
barfoo:insert({'foo', 1})
---
- ['foo', 1]
...
barfoo:insert({'bar', 2})
---
- ['bar', 2]
...
barfoo:insert({'foobar', 1000})
---
- ['foobar', 1000]
...
box.sql.execute("SELECT foo, bar FROM barfoo")
---
- - [2, 'bar']
  - [1, 'foo']
  - [1000, 'foobar']
...
box.sql.execute("SELECT foo, bar FROM barfoo WHERE foo==2")
---
- - [2, 'bar']
...
box.sql.execute("SELECT foo, bar FROM barfoo WHERE bar=='foobar'")
---
- - [1000, 'foobar']
...
box.sql.execute("SELECT foo, bar FROM barfoo WHERE foo>=2")
---
- - [2, 'bar']
  - [1000, 'foobar']
...
box.sql.execute("SELECT foo, bar FROM barfoo WHERE foo<=2")
---
- - [1, 'foo']
  - [2, 'bar']
...
-- cleanup
barfoo:drop()
---
...
