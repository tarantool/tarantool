fio  = require('fio')
---
...
net = require('net.box')
---
...
fiber = require('fiber')
---
...
ext = (jit.os == "OSX" and "dylib" or "so")
---
...
build_path = os.getenv("BUILDDIR")
---
...
reload1_path = build_path..'/test/box/reload1.'..ext
---
...
reload2_path = build_path..'/test/box/reload2.'..ext
---
...
reload_path = "reload."..ext
---
...
_ = fio.unlink(reload_path)
---
...
c = net.connect(os.getenv("LISTEN"))
---
...
box.schema.func.create('reload.foo', {language = "C"})
---
...
box.schema.user.grant('guest', 'execute', 'function', 'reload.foo')
---
...
_ = box.schema.space.create('test')
---
...
_ = box.space.test:create_index('primary', {parts = {1, "integer"}})
---
...
box.schema.user.grant('guest', 'read,write', 'space', 'test')
---
...
_ = fio.unlink(reload_path)
---
...
fio.symlink(reload1_path, reload_path)
---
- true
...
--check not fail on non-load func
box.schema.func.reload("reload.foo")
---
...
-- test of usual case reload. No hanging calls
box.space.test:insert{0}
---
- [0]
...
c:call("reload.foo", {1})
---
- []
...
box.space.test:delete{0}
---
- [0]
...
_ = fio.unlink(reload_path)
---
...
fio.symlink(reload2_path, reload_path)
---
- true
...
box.schema.func.reload("reload.foo")
---
...
c:call("reload.foo")
---
- []
...
box.space.test:select{}
---
- - [-1]
  - [0]
  - [1]
...
box.space.test:truncate()
---
...
-- test case with hanging calls
_ = fio.unlink(reload_path)
---
...
fio.symlink(reload1_path, reload_path)
---
- true
...
box.schema.func.reload("reload.foo")
---
...
fibers = 10
---
...
for i = 1, fibers do fiber.create(function() c:call("reload.foo", {i}) end) end
---
...
while box.space.test:count() < fibers do fiber.sleep(0.001) end
---
...
-- double reload doesn't fail waiting functions
box.schema.func.reload("reload.foo")
---
...
_ = fio.unlink(reload_path)
---
...
fio.symlink(reload2_path, reload_path)
---
- true
...
box.schema.func.reload("reload.foo")
---
...
c:call("reload.foo")
---
- []
...
while box.space.test:count() < 2 * fibers + 1 do fiber.sleep(0.001) end
---
...
box.space.test:select{}
---
- - [-10]
  - [-9]
  - [-8]
  - [-7]
  - [-6]
  - [-5]
  - [-4]
  - [-3]
  - [-2]
  - [-1]
  - [0]
  - [1]
  - [2]
  - [3]
  - [4]
  - [5]
  - [6]
  - [7]
  - [8]
  - [9]
  - [10]
...
box.schema.func.drop("reload.foo")
---
...
box.space.test:drop()
---
...
_ = fio.unlink(reload_path)
---
...
fio.symlink(reload1_path, reload_path)
---
- true
...
box.schema.func.create('reload.test_reload', {language = "C"})
---
...
box.schema.user.grant('guest', 'execute', 'function', 'reload.test_reload')
---
...
ch = fiber.channel(2)
---
...
-- call first time to load function
c:call("reload.test_reload")
---
- [[1]]
...
_ = fiber.create(function() ch:put(c:call("reload.test_reload")) end)
---
...
_ = fio.unlink(reload_path)
---
...
fio.symlink(reload2_path, reload_path)
---
- true
...
box.schema.func.reload("reload.test_reload")
---
...
_ = fiber.create(function() ch:put(c:call("reload.test_reload")) end)
---
...
ch:get()
---
- [[1]]
...
ch:get()
---
- [[2]]
...
box.schema.func.create('reload.test_reload_fail', {language = "C"})
---
...
box.schema.user.grant('guest', 'execute', 'function', 'reload.test_reload_fail')
---
...
c:call("reload.test_reload_fail")
---
- [[2]]
...
_ = fio.unlink(reload_path)
---
...
fio.symlink(reload1_path, reload_path)
---
- true
...
s, e = pcall(box.schema.func.reload, "reload.test_reload")
---
...
s, string.find(tostring(e), 'test_reload_fail') ~= nil
---
- false
- true
...
c:call("reload.test_reload")
---
- [[2]]
...
c:call("reload.test_reload_fail")
---
- [[2]]
...
box.schema.func.drop("reload.test_reload")
---
...
box.schema.func.drop("reload.test_reload_fail")
---
...
_ = fio.unlink(reload_path)
---
...
