# Added for autogenerated headers and LuaJIT ones.
include_directories(${PROJECT_SOURCE_DIR}/src)
include_directories(${PROJECT_BINARY_DIR}/src)
include_directories(${PROJECT_SOURCE_DIR}/src/box)

# fiber.h may require libunwind.h. Add proper header search paths.
function(add_libunwind_include_directory target)
  if (ENABLE_BACKTRACE AND ENABLE_BUNDLED_LIBUNWIND)
    target_include_directories(${target} SYSTEM PRIVATE ${LIBUNWIND_INCLUDE_DIR})
  endif()
endfunction()

# A special target with fuzzer and sanitizer flags.
add_library(fuzzer_config INTERFACE)

target_compile_options(
    fuzzer_config
    INTERFACE
        $<$<NOT:$<BOOL:${OSS_FUZZ}>>:
        -fsanitize=fuzzer
        >
        $<$<BOOL:${OSS_FUZZ}>:
        ${CXX}
        ${CXXFLAGS}
        >
)
target_link_libraries(
    fuzzer_config
    INTERFACE
        $<$<NOT:$<BOOL:${OSS_FUZZ}>>:
        -fsanitize=fuzzer
        >
        $<$<BOOL:${OSS_FUZZ}>:
        $ENV{LIB_FUZZING_ENGINE}
        >
)

# Use PUBLIC to force 'fuzzer_config' for all dependent targets.
add_executable(csv_fuzzer csv_fuzzer.c)
target_link_libraries(csv_fuzzer PUBLIC csv fuzzer_config)

add_executable(uri_fuzzer uri_fuzzer.c)
target_link_libraries(uri_fuzzer PUBLIC uri fuzzer_config)

add_executable(http_parser_fuzzer http_parser_fuzzer.c)
target_link_libraries(http_parser_fuzzer PUBLIC http_parser fuzzer_config)

add_executable(swim_proto_member_fuzzer swim_proto_member_fuzzer.c)
target_link_libraries(swim_proto_member_fuzzer PUBLIC swim fuzzer_config)
add_libunwind_include_directory(swim_proto_member_fuzzer)

add_executable(swim_proto_meta_fuzzer swim_proto_meta_fuzzer.c)
target_link_libraries(swim_proto_meta_fuzzer PUBLIC swim fuzzer_config)
add_libunwind_include_directory(swim_proto_meta_fuzzer)

add_executable(datetime_parse_full_fuzzer datetime_parse_full_fuzzer.c)
target_link_libraries(datetime_parse_full_fuzzer PUBLIC core fuzzer_config)

add_executable(datetime_strptime_fuzzer datetime_strptime_fuzzer.c)
target_link_libraries(datetime_strptime_fuzzer PUBLIC core fuzzer_config)

add_executable(mp_datetime_fuzzer mp_datetime_fuzzer.c)
target_link_libraries(mp_datetime_fuzzer PUBLIC core fuzzer_config)

set(fuzzing_binaries csv_fuzzer
                     datetime_parse_full_fuzzer
                     datetime_strptime_fuzzer
                     http_parser_fuzzer
                     mp_datetime_fuzzer
                     swim_proto_member_fuzzer
                     swim_proto_meta_fuzzer
                     uri_fuzzer)

add_custom_target(fuzzers
                  DEPENDS ${fuzzing_binaries}
                  COMMENT "Build fuzzers")
