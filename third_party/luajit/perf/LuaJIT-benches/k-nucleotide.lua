-- The benchmark that checks the performance of hash tables.
-- The program reads the redirected FASTA format file from stdin,
-- extracts DNA sequence THREE, and counts the specific sequences.
-- For the details see:
-- https://benchmarksgame-team.pages.debian.net/benchmarksgame/description/knucleotide.html

local bench = require('bench').new(arg)

local function kfrequency(seq, freq, k, frame)
  local sub = string.sub
  local k1 = k - 1
  for i=frame,#seq-k1,k do
    local c = sub(seq, i, i+k1)
    freq[c] = (freq[c] or 0) + 1
  end
end

local function count(seq, frag)
  local k = #frag
  local freq = {}
  for frame=1,k do kfrequency(seq, freq, k, frame) end
  return freq[frag]
end

local function frequency(seq, k)
  local freq = {}
  for frame=1,k do kfrequency(seq, freq, k, frame) end
  local sfreq, sn, sum = {}, 1, 0
  for c,v in pairs(freq) do sfreq[sn] = c; sn = sn + 1; sum = sum + v end
  table.sort(sfreq, function(a, b)
    local fa, fb = freq[a], freq[b]
    return fa == fb and a > b or fa > fb
  end)
  local res = {}
  for _,c in ipairs(sfreq) do
    res[c] = freq[c] * 100 / sum
  end
  return res
end

local function readseq()
  local sub = string.sub
  for line in io.lines() do
    if sub(line, 1, 1) == ">" and sub(line, 2, 6) == "THREE" then break end
  end
  local lines, ln = {}, 0
  for line in io.lines() do
    local c = sub(line, 1, 1)
    if c == ">" then
      break
    elseif c ~= ";" then
      ln = ln + 1
      lines[ln] = line
    end
  end
  return string.upper(table.concat(lines, "", 1, ln))
end

local function check_freq(res, expected)
  for k,v in pairs(expected) do
    assert(string.format("%0.3f", res[k]) == v,
           "Incorrect frequency for fragment " .. k)
  end
end

-- The input is generated by `fasta.lua 5e6'. The check function
-- is corresponding.
local N = 5e6
-- See <libs/fasta.lua> for the details.
local items = N * 5
bench:add({
  name = "k_nucleotide",
  payload = function()
    local seq = readseq()
    local sfreq1 = frequency(seq, 1)
    local sfreq2 = frequency(seq, 2)
    local GGT  = count(seq, "GGT")
    local GGTA = count(seq, "GGTA")
    local GGTATT = count(seq, "GGTATT")
    local GGTATTTTAATT = count(seq, "GGTATTTTAATT")
    local GGTATTTTAATTTATAGT = count(seq, "GGTATTTTAATTTATAGT")

    local res = {
      sfreq1 = sfreq1,
      sfreq2 = sfreq2,
      GGT  = GGT,
      GGTA = GGTA,
      GGTATT = GGTATT,
      GGTATTTTAATT = GGTATTTTAATT,
      GGTATTTTAATTTATAGT = GGTATTTTAATTTATAGT,
    }
    -- XXX: Reset input for the non-check iteration.
    io.stdin:seek("set", 0)
    return res
  end,
  checker = function(res)
    check_freq(res.sfreq1, {
      A = "30.296",
      T = "30.149",
      C = "19.800",
      G = "19.754",
    })
    check_freq(res.sfreq2, {
      AA = "9.177",
      TA = "9.132",
      AT = "9.130",
      TT = "9.091",
      CA = "6.002",
      AC = "6.001",
      AG = "5.987",
      GA = "5.984",
      CT = "5.971",
      TC = "5.971",
      GT = "5.957",
      TG = "5.956",
      CC = "3.917",
      GC = "3.911",
      CG = "3.909",
      GG = "3.902",
    })

    assert(res.GGT == 294331)
    assert(res.GGTA == 89290)
    assert(res.GGTATT == 9462)
    assert(res.GGTATTTTAATT == 178)
    assert(res.GGTATTTTAATTTATAGT == 178)
    return true
  end,
  items = items,
})

bench:run_and_report()
