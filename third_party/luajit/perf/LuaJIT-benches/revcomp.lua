-- The benchmark to check the performance of hash table lookups by
-- constant keys, string manipulations, and read/write
-- operations.
-- This benchmark reads the line-by-line a redirected FASTA format
-- file from stdin, which is generated by the <fasta.lua>
-- benchmark, and writes the id, description, and the
-- reverse-complement sequence in FASTA format to stdout.
-- For the details see:
-- https://benchmarksgame-team.pages.debian.net/benchmarksgame/description/revcomp.html

local bench = require("bench").new(arg)

local sub = string.sub
iubc = setmetatable({
  A="T", C="G", B="V", D="H", K="M", R="Y",
  a="T", c="G", b="V", d="H", k="M", r="Y",
  T="A", G="C", V="B", H="D", M="K", Y="R", U="A",
  t="A", g="C", v="B", h="D", m="K", y="R", u="A",
  N="N", S="S", W="W", n="N", s="S", w="W",
}, { __index = function(t, s)
  local r = t[sub(s, 2)] .. t[sub(s, 1, 1)]; t[s] = r; return r end })

local stdout = io.output()

bench:add({
  name = "revcomp",
  -- The compare with the result output file is inconvenient.
  skip_check = true,
  setup = function()
    io.output("/dev/null")
  end,
  payload = function()
    local wcode = [=[
    return function(t, n)
      if n == 1 then return end
      local iubc, sub, write = iubc, string.sub, io.write
      local s = table.concat(t, "", 1, n - 1)
      for i = #s - 59, 1, -60 do
        write(]=]
    for i = 59, 3, -4 do
      wcode = wcode .. "iubc[sub(s, i + " .. (i - 3) .. ", i + " .. i .. ")], "
    end
    wcode = wcode .. [=["\n")
      end
      local r = #s % 60
      if r ~= 0 then
        for i = r, 1, -4 do write(iubc[sub(s, i - 3 < 1 and 1 or i - 3, i)]) end
        write("\n")
      end
    end
    ]=]
    local writerev = loadstring(wcode)()

    local t, n = {}, 1
    for line in io.lines() do
      local c = sub(line, 1, 1)
      if c == ">" then
        writerev(t, n)
        io.write(line, "\n")
        n = 1
      elseif c ~= ";" then t[n] = line; n = n + 1 end
    end
    writerev(t, n)
    -- Repeat operation several times.
    io.stdin:seek("set", 0)
  end,
  teardown = function()
    io.output(stdout)
  end,
  -- Amount of symbols in the input file.
  items = 5e6,
})

bench:run_and_report()
