# 3.2.2

Date: 2025-08-22
Tag: 3.2.2

## Overview

Tarantool 3.x is the recommended release series. Users of Tarantool 2.11 are
encouraged to update to the latest 3.x release.

This release resolves 106 bugs since 3.2.1.

## Announcement: `double` field type problems

Users who ever used the `double` field type in vinyl indexes might have their
indexes broken. Regardless of this release. Preferably prior to the upgrade the
users must get rid of the `double` indexed field type in vinyl. It must be
drop-in replaceable by the `number` field type.

The reason is that the sorting of `double` fields would always compare the field
values as C-language doubles, even when actual integers are stored. This works
fine for small numbers, but starting from 2^53 the double-style comparison
loses precision. For example, 18446744073709551615 and 18446744073709551614
would be considered the same values.

Besides, point-lookups in such index are going to be broken by design too -
looking up by 18446744073709551615 can return 18446744073709551614 and many
other integers around this point.

Unfortunately, even if the user doesn't have the `double` type in any vinyl
indexes, but **ever had it before**, it is still unsafe. A `double` index
altered to `number` or `scalar` would remain broken. It is **very important that
users rebuild all the vinyl indexes that have or ever had the `double` field
type in them**. What is worse, just an alter `double` -> `number` **won't
work**. The old index must be dropped and a new one must be created. In any
order.

Please consider the full list of user-visible changes below.

## Compatibility

Tarantool 2.x and 3.x are compatible in the binary data layout, client-server
protocol, and replication protocol. It means that the updating may be performed
with zero downtime for read requests and the order-of-network-lag downtime for
write requests.

Please follow the [upgrade procedure][upgrade] to plan your update actions.

Users of Tarantool 2.x may be interested in the [compat][compat] options that
allow to imitate some 2.x behavior. This allows to perform application code
update step-by-step, not all-at-once.

[compat]: https://www.tarantool.io/en/doc/latest/reference/configuration/configuration_reference/#compat

[upgrade]: https://www.tarantool.io/en/doc/latest/book/admin/upgrades/

## Bugs fixed

### Core

* Fixed a bug that prevented `update()` operations on the fields with a
  fixed-size floating-point type (gh-9929).
* The `bootstrap_leader` configuration option is now dynamic (gh-10604).
* Fixed a bug when a server could crash if a client sent an IPROTO replication
  request without waiting for pending requests to complete (gh-10155).
* Fixed a bug when IPROTO_INDEX_NAME was mapped into a wrong index identifier (gh-9923).
* Fixed a bug when the `sequence:reset()` call result was not recovered
  after the server restart (gh-9871).
* Fixed log message being truncated to 1024 bytes with JSON logger (gh-10918).
* Fixed several bugs in the numbers comparison and hashing in tuple keys. It
  allowed to insert the same key multiple times into a unique index, and
  sometimes wouldn't allow to find an existing key in an index. Could happen
  when numbers were encoded in MessagePack suboptimally and when the `double`
  field type was used (gh-9965).
* Fixed a bug where passwords are leaked into logs
  when using `listen` and `bootstrap_leader` options.
* Now the server binds all URIs matching the `listen` parameter in the box
  configuration. Previously, it bound only a single URI per entry. Now, providing
  a single port number makes all interfaces be listened on that port. It is
  also possible now to bind multiple interfaces with a single port number
  (gh-7152).
* Fixed the master node crash at processing anonymous
  requests with a nil instance uuid (gh-11531).
* Improved the calculation of `waste_size` in `tuple:info()` and `space:stat()`
  (gh-10217).
* Fixed a bug when `box.ctl.promote` could hang if a candidate server got
  a message from a follower that the leader was already seen (gh-10836).
* Fixed a bug when `box.ctl.promote` could crash if a candidate
  server lost and regained quorum during promotion (gh-10836).
* Fixed a misleading error thrown on an attempt to revoke privileges from the
  'admin' user and 'super' role (gh-11526).
* Fixed reading after MsgPack end of an invalid interval MsgPack on decoding.
  Fixed checking bounds on decoding of year, month, week, and nanosecond, and
  adjusted the fields of the interval MsgPack (gh-10360).
* Fixed a crash, undefined behaviour, and inconsistent data across replicas that
  could all occur when the WAL queue was full (`box.cfg.wal_queue_max_size` was
  reached) and transactions blocked on that queue were woken up or cancelled
  spuriously (for example, manually via `fiber:wakeup()` or `fiber:cancel()`).
  (gh-11180).
* Fixed a bug when the `drop_while` method of index iterators (`index:pairs()`,
  `space:pairs()`) dropped an extra element (gh-6403).
* Fixed the issue with hanging write operations forever triggered by heavy
  write load and WAL writing failures on cascade rollback (gh-11081).
* Fixed a bug when cancelling a fiber waiting in WAL queue corrupted the
  the WAL (gh-11078).
* Fixed a bug when the timestamps of snapshots created before the server restart
  were not taken into account with `checkpoint_interval` enabled (gh-9820).
* Fixed a bug when the sizes of `*.xlog` files created before the server restart
  were not taken into account during the `checkpoint_wal_threshold` exceedance
  checks (gh-9811).
* Fixed a bug when transactions in the WAL queue were not rolled back on WAL
  error (gh-11179).
* Fixed bug when WAL queue is no flushed properly. In particular
  when building index of vinyl space. In the latter case it may lead
  the new index missing data from transactions in the queue (gh-11118, gh-11119).
* Fixed bug when `box.commit({wait = 'none'})` could yield (gh-11224).
* Fixed a bug where tuples with JSON paths in a sequential
  field order could not be found in a hash index.
* Fixed a bug when the `box.schema.user.info()` function could fail if a current
  user was granted with a non-`public` role (gh-10057).
* Fixed a crash on an attempt to decode a malformed MsgPack extension
  with zero payload (gh-10361).


### Memtx

* Fixed a crash when a transaction that was processed concurrently with
  background index build was rolled back due to WAL failure (gh-10620).
* Fixed a crash when memtx MVCC tried to abort an already committed
  non-memtx transaction if it used a system space view or tried to
  perform a DDL operation (gh-10715).
* Fixed a bug when Tarantool with memtx MVCC enabled was aborted on
  workload with many `index:get()` operations reading nothing (gh-11022).
* Tarantool allowed to create multikey and functional indexes with
  memtx MVCC enabled, but they were not supported. This led to a crash
  or a panic. Now Tarantool raises an error when one tries to create
  an index of the kind with memtx MVCC enabled (gh-6385, gh-11099).
* Fixed a bug that caused the memtx MVCC to miss conflicts over key definitions
  that used the number type or collations (gh-10159, gh-11292).
* Disallowed alteration of the primary index in a space with
  non-unique or nullable secondary indexes because such alters
  would crash Tarantool (gh-10951).
* Fixed a bug when altering a multikey index and creating a new one over
  the same field could lead to a crash or undefined behavior (gh-11291).
* Now DDL operations abort only transactions related to the space that
  they are modifying (gh-10377).

### Vinyl

* Fixed a bug when `index.stat()` and `index.len()` could report a wrong number
  of in-memory statements for a non-unique multi-key index of a space with
  the `defer_deletes` option enabled (gh-10751).
* Fixed a bug when a deleted tuple wasn't purged from a secondary index data
  stored on disk in case it was updated more than once in the same transaction.
  The bug couldn't result in inconsistent query results, but it could lead to
  performance degradation and increased disk usage (gh-10820, gh-10822).
* Fixed a bug when joining a new replica to a master instance that experiences
  a heavy write load severely degrades the master instance performance.
  The fix should also speed up long-running scan requests (gh-10846).
* Fixed a bug when a tuple could disappear from a multikey index in case it
  replaced a tuple with duplicate multikey array entries created in the same
  transaction. With the enabled `defer_deletes` space option, the bug could
  also trigger a crash (gh-10869, gh-10870).
* Fixed a bug when the tuple cache was not properly invalidated in case
  a WAL write error occurred while committing a `space.delete()` operation.
  The bug could lead to a crash or an invalid read query result (gh-10879).
* Fixed a bug when a deleted secondary index key wasn't purged on compaction
  of a space with the `defer_deletes` option enabled (gh-10895).
* Fixed a use-after-free bug in the transaction manager that could be triggered
  by a race between DDL and DML operations affecting the same space (gh-10707).
* Fixed a bug when aborting a transaction by timeout while it was executing
  a statement could trigger a crash (gh-11088).
* Fixed a bug in the tuple cache when a transaction operating in a read view
  could skip a tuple deleted after the read view creation (gh-11079, gh-11294).
* Fixed a bug in the tuple cache when a tuple could become inaccessible via
  a secondary index after a transaction rollback caused by a WAL write error
  (gh-11140).
* Fixed a bug when the garbage collector purged run files left after a dropped
  space without waiting for compaction completion. The bug could result in
  a compaction failure with a "No such file or directory" error (gh-11163).
* Fixed a bug when `space:truncate()` failed with `ER_TRANSACTION_YIELD`
  (gh-11249).

### Replication

* Fixed a bug when master entered read-only mode and couldn't add new replicas
  to the replica set after replication reconfiguration (gh-10760).
* RAFT requests are now sent with 0 (not local) GROUP_ID (gh-10727).
* Fixed a bug when the RAFT state wasn't sent during the `META_JOIN` stage,
  which could lead to split-brain (gh-10089).
* Fixed a bug when anonymous replicas could participate in elections or even
  be chosen as a leader. It is now forbidden to configure a replica so
  that `replication_anon` is `true` and `election_mode` is not `off`
  (gh-10561).
* Fixed a crash which could happen during relay thread shut down (gh-9920).
* Fixed a bug when the node configured as
  `box.cfg.bootstrap_mode` = `'config'`/`'supervised''` didn't switch to
  the 'orphan' status even if it failed to synchronize with each of the
  connected nodes (gh-11156).
* Fixed replication hanging in the relay thread when transmitting large tuples
  (more than several megabytes) (gh-11604).

### LuaJIT

Backported patches from the vanilla LuaJIT trunk (gh-10709, gh-11055, gh-11278).
The following issues were fixed as part of this activity:

* Fixed compilation of `getmetatable()` for `io` objects.
* Fixed dirty reads from recorded `IR_NOP`.
* Fixed fusing optimization across `table.clear()` or insertion of a new key.
* Disabled FMA optimization on aarch64 to avoid incorrect results in floating
  point arithmetics. Optimization may be enabled for the JIT engine via the
  command `jit.opt.start("+fma")`.
* Fixed machine code zone overflow for trace recording on x86/x64.
* Fixed possible infinite loop during recording a chunk that uses upvalues.
* Fixed recording of `bit.bor()`/`bit.bxor()`/`bit.band()` with string
  arguments.
* Fixed parsing of `for _ in` loop.
* Fixed compiler warning in `setfenv()` / `getfenv()` with negative levels as
  the argument.
* Fixed register allocation for stores into sunk values (gh-10746).
* Fixed a crash when using a Lua C function as a vmevent handler for trace
  events.
* Fixed the compilation of `...` in `select()`.
* Fixed closing the report file without samples for `jit.p`.
* Fixed the OOM error handling during recording of the `__concat` metamethod.
* Fixed the second `trace.flush()` call for the already flushed trace.
* Fixed bit op coercion for shifts in DUALNUM builds.
* Fixed `IR_ABC` hoisting.
* Returned the rehashing of the cdata finalizer table at the end of the GC
  cycle to avoid memory overgrowing for cdata-intensive workloads.
* Fixed JIT slot overflow during recording of trace with up-recursion.
* Fixed stack overflow handling.
* Fixed potential file descriptor leaks in `loadfile()`.
* Fixed error generation in `loadfile()`.
* Fixed incorrect snapshot restore due to stack overflow.
* Fixed assembling of IR SLOAD for the aarch64 architecture.
* Fixed assembling of IR HREFK for the aarch64 architecture.
* Fixed incorrect `stp`/`ldp` instructions fusion on aarch64.

### Lua

* Now `fun.chain` works correctly with iterators without `param`.
* Now `fun.drop_while` supports stateful iterators.
* Populated the `fun` module with the missing `maximum_by` alias
  of `max_by`.
* Now `fun.nth` and `fun.length` work correctly with Luafun iterators.

#### Netbox

* Fixed a bug when the request counter used by a `net.box` client to implement
  the graceful shutdown protocol could underflow while it was fetching the
  schema from the remote end. In case of a debug build, the bug would crash
  the client. In case of a release build, the bug would result in a timeout
  while executing the remote server shutdown (gh-11062).

### SQL

* Fixed a bug when an SQL count statement wasn't tracked by MVCC if it was
  the first in a transaction (gh-10825).
* Fixed undefined behavior of SQL when using positive `MP_INT` numbers in
  MessagePack anywhere (bound arguments, tuples, C functions) (gh-10132).

### Config

* Fixed handling of `log.modules` option removal (gh-10728).
* Fixed handling of `wal.ext` option removal (ghe-963).
* Fixed handling of `audit_log.spaces` option removal (ghe-964).
* Don't fail if the `sharding.roles` option is not set for some instances
  (gh-10458).
* `schema:get()`/`schema:set()` and `config:get()` no longer changes the
  passed path if it is passed as a table (gh-10855).
* Now Tarantool writes a detailed error message if it finds
  replica sets with the same names in different groups or instances
  with the same names in different replica sets in the provided
  configuration (gh-10347).
* `<schema object>:merge()` now performs a deep merge inside an `any` scalar
  value if left-hand and right-hand values are both tables, where all the keys
  are strings. This way the cluster configuration options that are marked as
  `any` in the schema (fields of `app.cfg` and `roles_cfg`) are merged deeply
  (gh-10450).
* Now the `failover` section can be defined only in the global configuration
  scope.

### Recovery

* Fixed a bug where a master node that crashed and lost its xlog files for
  some reason might never get some of its own rows from upstreams after
  reconnecting. A new ro-reason "waiting_for_own_rows" was introduced for this.
  Now, until the instance has received all its rows, it is in this mode and
  remains read-only (gh-10592).

### Tools

Fixed a bunch of bugs in LuaJIT profilers:
* `misc.sysprof.stop()` returns a correct error message if the profiler is not
  running.
* `misc.sysprof.start()` now raises an error if an argument has an incorrect
  type.
* Fixed the sysprof crash (gh-11185, gh-11429) when a sample was collected outside
  the LuaJIT VM.

Made LuaJIT profilers more user-friendly:
* `misc.memprof.start()` without arguments writes the dump into the default file
  named `memprof.bin` instead of raising an error.
* `misc.sysprof.start()` provides more verbose errors in case of profiler
  misuse.
* If the profiler is disabled for the target platform, it is now mentioned in
  the error message explicitly.
* `misc.sysprof.start()` without arguments starts the profiler in the default
  mode `"D"`.
* It is now possible to call LuaJIT's platform profile function
  `misc.sysprof.report()` during the profiling as well (gh-11229).


### Upgrade

* Automatically fix incorrect format of user-defined spaces and empty password
  for users during upgrade (gh-10180).

## Testing

### Core

* Added the `box.ctl.wal_sync()` function, which waits until
  all submitted writes are successfully flushed to the disk.
  Throws an error if a write fails. After the function is
  executed one may reliably use box.info.vclock for comparisons
  when choosing a new master (gh-10142).
