<!DOCTYPE book [
<!ENTITY % tnt SYSTEM "../tnt.ent">
%tnt;
]>
<chapter xmlns="http://docbook.org/ns/docbook" version="5.0"
         xmlns:xi="http://www.w3.org/2001/XInclude" 
         xmlns:xlink="http://www.w3.org/1999/xlink"
         xml:id="configuration-reference">

<title>Configuration reference</title>
<blockquote><para>
  This chapter provides a reference of options which
  can be set in the command line or
  <filename>tarantool.cfg</filename> configuration file.
</para></blockquote>

<para>
Tarantool splits its configuration parameters between command
line options and a configuration file. Command line flags
are provided for the most basic properties only: the rest
must be set in the configuration file.
At runtime, this allows to disambiguate the source of
a configuration setting: it unequivocally comes either from
the command line, or from the configuration file, but never from
both.
</para>

<section>
<title>Command line options</title>
  <para>
    Tarantool follows the <citetitle
    xlink:href="http://www.gnu.org/prep/standards/standards.html#Command_002dLine-Interfaces">GNU
    standard</citetitle> for its command line interface: long
    options start with a double dash (<option>--option</option>),
    their short counterparts use a single one (<option>-o</option>).
    For phrases, both dashes and
    underscores can be used as word separators
    (<option>--cfg-get</option> and <option>--cfg_get</option> both work).
    If an option requires an argument, you can either separate it
    with a space or equals sign (<option>--cfg-get=pid_file</option> and
    <option>--cfg-get pid_file</option> both work).
  </para>
  <itemizedlist>
    <listitem xml:id="help-option">
      <para><option>--help</option>, <option>-h</option></para>
      <para>Print an annotated list of all available options and exit.</para>
    </listitem>

    <listitem xml:id="version-option">
      <para><option>--version</option>, <option>-V</option></para>
      <para>Print product name and version, for example:
        <programlisting><prompt>$ </prompt> ./tarantool_box --version
Tarantool/Box 1.4.0-69-g45551dd
        </programlisting>
        In this example:
        <simplelist>
          <member>
            <quote>Tarantool</quote> is the name
            of the reusable asynchronous networking programming framework.
         </member>
          <member>
            <quote>Box</quote> is the name
            of the storage back-end.
         </member>
          <member>
            The 3-number version follows the standard
            <literal>&lt;major&gt;-&lt;minor&gt;-&lt;patch&gt;</literal>
            scheme, in which <literal>&lt;major&gt;</literal> number
            is changed only rarely, <literal>&lt;minor&gt;</literal>
            is incremented for each new milestone and
            indicates possible incompatible changes,
            and <literal>&lt;patch&gt;</literal> stands for the number of
            bug fix releases made after the start of the
            milestone. The optional commit number and
            commit SHA1 are output for non-released versions
            only, and indicate how much this particular build has diverged
            from the last release.
         </member>
        </simplelist>
      </para>
      <note><para>
        Tarantool uses <link
        xlink:href="http://www.kernel.org/pub/software/scm/git/docs/git-describe.html">git describe</link> to produce its version id, and
        this id can be used at any time to check out the
        corresponding source from our <link
        xlink:href="git://github.com/mailru/tarantool.git">git repository</link>.
      </para></note>
    </listitem>

    <listitem xml:id="config-option">
      <para><option>--config=</option><userinput><filename>/path/to/config.file</filename></userinput>, <option>-c</option></para>
      <para>
        Tarantool does not start without a configuration file. By
        default, the server looks for file named
        <filename>tarantool.cfg</filename> in the current working
        directory. An alternative location can be provided using
        this option.
      </para>
    </listitem>

    <listitem>
      <para><option>--check-config</option></para>
      <para>Check the configuration file for errors. This option is
        normally used on the command line
        before <quote>reload configuration</quote>
        is issued on the administrative port, to ensure that the new
        configuration is valid. When configuration is
        indeed correct, the program produces no output and returns <literal>0</literal>.
        Otherwise, information about discovered error is printed out
        and the program terminates with a non-zero value.
      </para>
    </listitem>

    <listitem>
      <para><option>--cfg-get=</option><userinput>option_name</userinput></para>
      <para>Given option name, print option value. If the
        option does not exist, or the configuration file is
        incorrect, an error is returned. If the option
        is not explicitly specified, its default value is used
        instead. Example:
        <programlisting><prompt>$ </prompt>./tarantool_box --cfg-get=admin_port
33015   </programlisting>
      </para>
    </listitem>
    <listitem>
      <para><option>--init-storage</option></para>
      <para>Initialize the directory, specified in <emphasis>vardir</emphasis>
      configuration option by creating an empty snapshot file in
      it. If <filename>vardir</filename> doesn't contain at
      least one snapshot, the server does not start. There is no
      <quote>magic</quote> with automatic initialization of
      <filename>vardir</filename> on boot to make
      potential system errors more noticeable. For example, if the
      operating system reboots and fails to mount the partition on
      which <filename>vardir</filename> is expected to reside, the
      <filename>rc.d</filename> or <command>service</command> script
      responsible for server restart will also fail, thanks to this
      option.
      </para>
    </listitem>

    <listitem>
      <para><option>--cat</option> <userinput>snapshot.file</userinput></para>
      <para>Print the snapshot file, pointed to by the argument,
      in a human-readable form. For each log record, log sequence
      number, time of entry, operation type and arguments are
      printed out. Example:
        <programlisting><prompt>$ </prompt>./tarantool_box --cat 00000000000000000002.xlog
lsn:2 tm:1301572243.430 t:65534 127.0.0.1:52728 INSERT n:0&lt;"1:\x01\x00\x00\x00"&gt;
lsn:3 tm:1301572287.509 t:65534 127.0.0.1:52728 INSERT n:0&lt;"1:\x01\x00\x00\x00", "hello"&gt;
lsn:4 tm:1301572313.691 t:65534 127.0.0.1:52728 UPDATE_FIELDS n:0flags:00000000 &lt;"1:\x01\x00\x00\x00"&gt; [field_no:1 op:set &lt;"world"&gt;]</programlisting>
      </para>
    </listitem>
  </itemizedlist>
  <para>
    The only two options which have effect on a running server are:
  </para>
  <itemizedlist>
    <listitem>
      <para><option>--verbose</option>, <option>-v</option></para>
      <para>Increase verbosity level in log messages. This option
      currently has no effect.</para>
    </listitem>

    <listitem>
      <para><option>--background</option>, <option>-b</option></para>
      <para>Detach from the controlling terminal and run in
        background.
        <caution><para>Tarantool uses
        <filename>stdout</filename> and
        <filename>stderr</filename> for
        debug and error log output. When starting the server with
        option <option>--background</option>, make sure to
        either redirect its standard out and standard error
        streams, or provide <emphasis>logger</emphasis> option
        in the configuration file, since otherwise all logging
        information will be lost</para></caution>
      </para>
    </listitem>
  </itemizedlist>
</section>

<section>
<title>The option file</title>
  <para>
    All advanced configuration parameters must be specified in a
    configuration file, which is required for server start. If no path to
    the configuration file is specified on the command line (see
    <option xlink:href="#config-option"
    xlink:title="--config=...">--config</option>),
    the server looks for a file named <filename>tarantool.cfg</filename>
    in the current working directory.
  </para>
  <para>
    To facilitate centralized and automated configuration
    management, runtime configuration modifications are supported
    solely through <olink targetptr="reload-configuration"/>
    administrative statement. Thus, the
    procedure to change Tarantool configuration at runtime is to
    edit the configuration file.  This ensures that, should the
    server get killed or restart, no unexpected changes to
    configuration can occur.
  </para>
  <para>
    Not all configuration file settings are changeable at runtime:
    such settings will be highlighted in this reference.
    If the same setting is given more than once, the latest occurrence
    takes effect.
    You can always invoke <olink targetptr="show-configuration"/>
    from the administrative console to show the current
    configuration.
  </para>
  <para>
    Tarantool maintains a set of all allowed configuration
    parameters in two template files, which are easy to maintain
    and extend:
    <filename xlink:href="https://github.com/mailru/tarantool/blob/master/cfg/core_cfg.cfg_tmpl">cfg/core_cfg.cfg_tmpl</filename>,
    <filename xlink:href="https://github.com/mailru/tarantool/blob/master/mod/box/box_cfg.cfg_tmpl">mod/box/box_cfg.cfg_tmpl</filename>.
    These files can always be used as a reference for any
    parameter in this manual.
  </para>

  <para>In addition, two working examples can be found in the source tree:
    <filename xlink:href="https://github.com/mailru/tarantool/blob/master/test/box/tarantool.cfg">test/box/tarantool.cfg</filename>,
    <filename xlink:href="https://github.com/mailru/tarantool/blob/master/test/box_big/tarantool.cfg">test/box_big/tarantool.cfg</filename>.
  </para>

  <table frame='all'>
    <title>Basic parameters</title>
    <tgroup cols='6' colsep='1' rowsep='1'>

      <thead>
        <row>
          <entry>Name</entry>
          <entry>Type</entry>
          <entry>Default</entry>
          <entry>Required?</entry>
          <entry>Dynamic?</entry>
          <entry>Description</entry>
        </row>
      </thead>

      <tbody>

        <row>
          <entry>username</entry>
          <entry>string</entry>
          <entry>""</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>UNIX user name to switch to after start.</entry>
        </row>

        <row>
          <entry>work_dir</entry>
          <entry>string</entry>
          <entry>""</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>A directory to switch to with chdir(2) after
          start. Can be relative to the starting directory.
          If not specified, the current working directory
          of the server is the same as starting
          directory.</entry>
        </row>

        <row>
          <entry>wal_dir</entry>
          <entry>string</entry>
          <entry>""</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>A directory to store the write ahead log files
          (WAL) in. Can be relative to work_dir. You may choose
          to separate your snapshots and logs and store them
          on separate disks. This is how this parameter is most
          commonly used. If not specified, defaults to work_dir.</entry>
        </row>

        <row>
          <entry>snap_dir</entry>
          <entry>string</entry>
          <entry>""</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>A directory to store snapshots in. Can be
          relative to work_dir. If not specified, defaults to
          work_dir. See also wal_dir.</entry>
        </row>
<!--
        <row>
          <entry>coredump</entry><entry>0 or 1</entry><entry>0</entry>
          <entry>Deprecated. Save core on abort/assert? You may
          turn off the coredump off when using ulimit</entry>
        </row>
-->
        <row>
          <entry>primary_port</entry>
          <entry>integer</entry>
          <entry><emphasis role="strong">none</emphasis></entry>
          <entry><emphasis role="strong">yes</emphasis></entry>
          <entry>no</entry>
          <entry>The read/write data port.
          Has no default value, so <emphasis
          role="strong">must be specified</emphasis>
          in the configuration file. Normally set to 33013.
          Note: a replica also binds to this port, accepts
          connections, but these connections can only serve
          reads until the replica becomes a master.</entry>
        </row>

        <row>
          <entry>secondary_port</entry>
          <entry>integer</entry>
          <entry>none</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>Additional, read-only port. Normally set to
          33014. Not used unless is set.</entry>
        </row>

        <row>
          <entry>admin_port</entry>
          <entry>integer</entry>
          <entry>none</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>The TCP port to listen on for administrative
          connections. Has no default value. Not used unless
          assigned a value. Normally set to 33015.</entry>
        </row>

        <row>
          <entry>pid_file</entry>
          <entry>string</entry>
          <entry>tarantool.pid</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>Store the process id in this file. Can be
          relative to work_dir.</entry>
        </row>

        <row>
          <entry>custom_proc_title</entry>
          <entry>string</entry>
          <entry>""</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>
            <para>Inject the given string into process title
            (what's shown in COMMAND column of <command>ps</command>
            and <command>top</command> commands). For example,
            an unmodified Tarantool/Box process group looks like:
            </para>
<programlisting>kostja@shmita:~$ ps -a -o command | grep box
tarantool: box:primary pri:33013 sec:33014 adm:33015</programlisting>
          <para>After "sessions" custom_proc_title is injected it
          looks like:</para>
<programlisting>kostja@shmita:~$ ps -a -o command | grep box
tarantool: box:primary@sessions pri:33013 sec:33014 adm:33015</programlisting>
          </entry>
        </row>

      </tbody>
    </tgroup>
  </table>

  <table frame='all'>
    <title>Configuring the storage</title>
    <tgroup cols='6' colsep='1' rowsep='1'>

      <thead>
        <row>
          <entry>Name</entry>
          <entry>Type</entry>
          <entry>Default</entry>
          <entry>Required?</entry>
          <entry>Dynamic?</entry>
          <entry>Description</entry>
        </row>
      </thead>

      <tbody>

        <row>
          <entry xml:id="slab_alloc_arena" xreflabel="slab_alloc_arena">slab_alloc_arena</entry>
          <entry>float</entry>
          <entry>1.0</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>How much memory Tarantool allocates to actually
          store tuples, <emphasis role="strong">in
          gigabytes</emphasis>. When the limit is reached, INSERT
          or UPDATE requests begin failing with error
          <olink targetptr="ERR_CODE_MEMORY_ISSUE"/>.
          While the server does not go
          beyond the defined limit to allocate tuples, there is
          additional memory used to store indexes and connection
          information.  Depending on actual configuration and
          workload, Tarantool can consume up to 20-40% of the
          limit set here.</entry>
        </row>

        <row>
          <entry>slab_alloc_minimal</entry>
          <entry>integer</entry>
          <entry>64</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>Size of the smallest allocation unit. It can be
          tuned down if most of the tuples are very small.</entry>
        </row>

        <row>
          <entry>slab_alloc_factor</entry>
          <entry>float</entry>
          <entry>2.0</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>Use slab_alloc_factor as the multiplier for
          computing the sizes of memory chunks that tuples are
          stored in. A lower value  may result in less wasted
          memory depending on the total amount of memory available
          and the distribution of item sizes.</entry> 
        </row>

        <row>
          <entry>namespace</entry>
          <entry>array of objects</entry>
          <entry>none</entry>
          <entry><emphasis role="strong">yes</emphasis></entry>
          <entry><emphasis role="strong">no</emphasis></entry>
          <entry>This is the main Tarantool parameter, describing
          the data structure that users get access to via
          client/server protocol. It holds an array of
          entries, and each entry represents a tuple set 
          served by the server. Every entry is a composite object,
          best seen as a C programming language "struct"
          <footnote><xi:include href="namespace.xml"/></footnote>.
          </entry>
        </row>

      </tbody>
    </tgroup>
  </table>

  <table frame='all'>
    <title>Binary logging, snapshots and replication</title>
    <tgroup cols='6' colsep='1' rowsep='1'>

      <thead>
        <row>
          <entry>Name</entry>
          <entry>Type</entry>
          <entry>Default</entry>
          <entry>Required?</entry>
          <entry>Dynamic?</entry>
          <entry>Description</entry>
        </row>
      </thead>

      <tbody>

        <row>
          <entry>panic_on_snap_error</entry>
          <entry>boolean</entry>
          <entry>1</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>If there is an error reading the snapshot (at
            server start), abort.</entry>
        </row>

        <row>
          <entry>panic_on_wal_error</entry>
          <entry>boolean</entry>
          <entry>0</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>If there is an error reading from a write ahead
          log (at server start), abort.</entry>
        </row>

      </tbody>
    </tgroup>
  </table>

<!--
Storage parameters.
******************

Replication settings
********************
# Write no more rows in WAL
rows_per_wal=500000, ro


# delay between loop iterations
io_collect_interval=0.0, ro
# do not write snapshot faster then snap_io_rate_limit MBytes/sec
snap_io_rate_limit=0.0, ro

# fsync WAL delay, only issue fsync if last fsync was wal_fsync_delay seconds ago
# WARNING: actually, several last requsts may stall for much longer
wal_fsync_delay=0, ro

# size of WAL writer requests buffer
wal_writer_inbox_size=128, ro

# network io readahead
readahead=16320
# size of listen backlog
backlog=1024, ro

-->
<!--
  </table>

  <table>
    <title>Replication</title>
-->
<!--
# Remote hot standby (if enabled server will run in hot standby mode
# continuously fetching WAL records from wal_feeder_ipaddr:wal_feeder_port
remote_hot_standby=0, ro
wal_feeder_ipaddr=NULL, ro
wal_feeder_port=0, ro

-->
<!--
  </table>

  <table>
    <title>Memcached support</title>
-->

  <table frame='all'>
    <title>Logging</title>
    <tgroup cols='6' colsep='1' rowsep='1'>

      <thead>
        <row>
          <entry>Name</entry>
          <entry>Type</entry>
          <entry>Default</entry>
          <entry>Required?</entry>
          <entry>Dynamic?</entry>
          <entry>Description</entry>
        </row>
      </thead>

      <tbody>

        <row>
          <entry>log_level</entry>
          <entry>integer</entry>
          <entry>4</entry>
          <entry>no</entry>
          <entry><emphasis role="strong">yes</emphasis></entry>
          <entry>How verbose the logging is. There are 5 log
            verbosity classes: 1 -- ERROR, 2 -- CRITICAL, 3 --
            WARNING, 4 -- INFO, 5 -- DEBUG. By setting log_level,
            you can enable logging of all classes below or equal
            to the given level. Tarantool prints its logs to the
            standard error stream by default, but this can be
            changed with "logger" configuration parameter.
          </entry>
        </row>

        <row>
          <entry>logger</entry>
          <entry>string</entry>
          <entry>""</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>By default, the log is sent to the standard
          error stream (<filename>stderr</filename>). If this
          option is given, Tarantool creates a child process,
          executes the given command in it, and pipes its standard
          output to the standard input of the created process.
          Example setting: <command>tee --append
          tarantool.log</command> (this will duplicate log output
          to <filename>stdout</filename> and a log file).
          </entry>
        </row>

        <row>
          <entry>logger_nonblock</entry>
          <entry>integer</entry>
          <entry>0</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>If this option is given, Tarantool does not
          block on the log file descriptor when it's not
          ready for write, and drops the message instead. If
          log_level is high, and a lot of messages go to the log
          file, setting this option to 1 may improve logging
          performance at the cost of some log messages getting
          lost.</entry>
        </row>

        <row>
          <entry>too_long_threshold</entry>
          <entry>float</entry>
          <entry>0.5</entry>
          <entry>no</entry>
          <entry><emphasis role="strong">yes</emphasis></entry>
          <entry>If processing a request takes longer than the
          given value (in seconds), warn about it in the log.
          Has effect only if log_level is no less than 3
          (WARNING).</entry>
        </row>

      </tbody>
    </tgroup>
  </table>

  <table frame='all'>
    <title>Memcached protocol support</title>
    <tgroup cols='6' colsep='1' rowsep='1'>

      <thead>
        <row>
          <entry>Name</entry>
          <entry>Type</entry>
          <entry>Default</entry>
          <entry>Required?</entry>
          <entry>Dynamic?</entry>
          <entry>Description</entry>
        </row>
      </thead>

      <tbody>

        <row>
          <entry>memcached</entry>
          <entry>integer</entry>
          <entry>0</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>Turn on Memcached mode. In this mode, Tarantool
            does not use secondary_port, and speaks memcached
            protocol on the primary port. In particular,
            memcached-style flags are supported, and expiration
            time can be set on tuples. Unlike Memcached, all data
            still goes to the binary log and to the replica, if
            latter one is set up, which means that power outage
            does not lead to a loss of all data.
          </entry>
        </row>

        <row>
          <entry>memcached_namespace</entry>
          <entry>integer</entry>
          <entry>23</entry>
          <entry>no</entry>
          <entry>no</entry>
          <entry>Namespace id to store memcached data in. The
          format of tuple is [key, metadata, value], with a hash
          index based on the key. </entry>
        </row>

        <row>
          <entry>memcached_expire_per_loop</entry>
          <entry>integer</entry>
          <entry>1024</entry>
          <entry>no</entry>
          <entry><emphasis role="strong">yes</emphasis></entry>
          <entry>How many records to consider per iteration of the
            expiration loop. Tuple expiration is performed in a separate
            <quote>green</quote> thread within our cooperative multitasking
            framework and this setting effectively limits how long
            the expiration loop stays on CPU uninterrupted.
          </entry>
        </row>

        <row>
          <entry>memcached_expire_full_sweep</entry>
          <entry>integer</entry>
          <entry>3600</entry>
          <entry>no</entry>
          <entry><emphasis role="strong">yes</emphasis></entry>
          <entry>Try to make sure that every tuple is considered
            for expiration within this time frame (in seconds).
            Together with memcached_expire_per_loop this defines
            how often the expiration <quote>green</quote> thread
            is scheduled on CPU.
          </entry>
        </row>

      </tbody>
    </tgroup>
  </table>

</section>
</chapter>

<!--
vim: tw=66 syntax=docbk
vim: spell spelllang=en_us
-->
